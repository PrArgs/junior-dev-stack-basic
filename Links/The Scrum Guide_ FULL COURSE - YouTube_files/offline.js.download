(function(g){var window=this;'use strict';var lYe=function(I){const U=new g.S6("und",new g.rf("Default","und",!0));U.captionTracks=I.captionTracks;return U},dgH=function(I){return new g.iw(function(U,t){let W=I.length;
const E=[];if(W){var Z=function(l,d){W--;E[l]=d;W==0&&U(E)},H=function(l){t(l)};
for(let l=0;l<I.length;l++){var w=I[l];g.eF(w,g.Pk(Z,l),H)}}else U(E)})},KDV=function({type:I,
payload:U}){I={type:I};U!==void 0&&(I.payload=U);return I},S9=function(I){I=I.key||I.id;
if(!I)throw Error("Entity key is missing");return I},vPL=function(){if(z4)return z4();
z4=g.K6("PersistentEntityStoreDb",{WD:{EntityStore:{TE:1},EntityAssociationStore:{TE:2}},shared:!1,upgrade(I,U){U(1)&&g.Oy(g.Tm(I,"EntityStore",{keyPath:"key"}),"entityType","entityType");U(2)&&(I=g.Tm(I,"EntityAssociationStore",{keyPath:["parentEntityKey","childEntityKey"]}),g.Oy(I,"byParentEntityKey","parentEntityKey"),g.Oy(I,"byChildEntityKey","childEntityKey"))},version:3});return z4()},csx=function(I){return g.UR(vPL(),I)},Lv=function(I){return g.UR((0,g.LPk)(),I)},$gw=function(I){return I instanceof
Error?new pv("UNKNOWN_ENCODE_ERROR",{originalMessage:I.message}):new pv("UNKNOWN_ENCODE_ERROR")},uMt=function(I){return I instanceof Error?new pv("UNKNOWN_DECODE_ERROR",{originalMessage:I.message}):new pv("UNKNOWN_DECODE_ERROR")},hxH=function(I,U){I=I instanceof pv?I:U(I);
g.b(I);throw I;},SLL=function(I,U,t){try{return I.D(U,t)}catch(W){hxH(W,$gw)}},mM=function(I){I=(new TextEncoder).encode(I).subarray(0,16);
const U=new Uint8Array(16);U.set(I);return U},LDt=function(I){const U=zxw[I];
if(U)return U;g.ae(new g.Lm("Entity model not found.",{entityType:I}))},Cv=function(I,U){a:{I=gk(I.J,U.version);
try{var t=I.J(U.data,U.key);break a}catch(W){hxH(W,uMt)}t=void 0}return t},yO=function(I,U,t){return I.B.objectStore("EntityStore").get(U).then(W=>{if(W){if(t&&W.entityType!==t)throw Error("Incorrect entity type");
return Cv(I,W)}})},Fc=function(I,U,t){return t?(t=t.map(W=>yO(I,W,U)),g.xG.all(t)):I.B.objectStore("EntityStore").index("entityType").getAll(IDBKeyRange.only(U)).then(W=>W.map(E=>Cv(I,E)))},mge=function(I,U,t){const W=S9(U);
return QO(I,W).then(()=>phQ(I,U,t))},fv=function(I,U,t){let W=I.D[t];
W||(W=new Set,I.D[t]=W);W.add(U)},j9=function(I,U,t){const W=S9(U),E=gk(I.J,1),Z={...U};
return I.B.objectStore("EntityStore").get(W).then(H=>{if(H){if(H.entityType!==t)throw Error("Incorrect entity type");Z.entityMetadata||(H=Cv(I,H),Z.entityMetadata=H.entityMetadata)}}).then(()=>{const H={key:W,
entityType:t,data:SLL(E,Z,W),version:1};return g.xG.all([I.B.objectStore("EntityStore").put(H),mge(I,Z,t)])}).then(()=>{fv(I,W,t);
return W})},AF=function(I,U,t){U=U.map(W=>j9(I,W,t));
return g.xG.all(U)},CDx=function(I,U,t){if(t.has(U))return g.xG.resolve(void 0);
t.add(U);return gPY(I,U).then(W=>I.B.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(U)).then(()=>W)).then(W=>{let E=g.xG.resolve(void 0);
for(const Z of W)E=E.then(()=>CDx(I,Z,t));
return E}).then(()=>{})},sA=function(I,U,t){if(t?.vz){const E=new Set;
return CDx(I,U,E).then(()=>{const Z=[];for(const H of E)Z.push(sA(I,H));return g.xG.all(Z).then(()=>{})})}const W=g.Oo(U).entityType;
return g.xG.all([I.B.objectStore("EntityStore").delete(U),QO(I,U)]).then(()=>{fv(I,U,W)})},QO=function(I,U){return I.B.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(U))},a6=function(I,U){return g.Pi(I.B.objectStore("EntityStore").index("entityType"),{query:IDBKeyRange.only(U)},t=>g.xG.all([t.delete(),
QO(I,t.cursor.primaryKey)]).then(()=>{fv(I,t.cursor.primaryKey,U);return g.MB(t)}))},ysY=function(I,U,t,W){const E=gk(I.J,1);
return yO(I,U,W).then(Z=>{if(Z){Z=g.c_(Z,t);var H={key:U,entityType:W,data:SLL(E,Z,U),version:1};return g.xG.all([I.B.objectStore("EntityStore").put(H),mge(I,Z,W)])}}).then(()=>{fv(I,U,W);
return U})},phQ=function(I,U,t){const W=S9(U);
t=LDt(t);if(!t)return g.xG.resolve([]);U=new t(U);I=I.B.objectStore("EntityAssociationStore");t=[];for(const E of U.J())t.push(I.put({parentEntityKey:W,childEntityKey:E}));return g.xG.all(t).then(E=>E.map(Z=>Z[1]))},gPY=function(I,U){const t=I.B.objectStore("EntityAssociationStore");
return t.index("byParentEntityKey").getAll(IDBKeyRange.only(U)).then(W=>{const E=[];for(const Z of W)E.push(t.index("byChildEntityKey").getAll(Z.childEntityKey));return g.xG.all(E)}).then(W=>{const E=[];
for(const Z of W)Z.length===1&&E.push(Z[0].childEntityKey);return E})},gk=function(I,U=0){I=I.B[U];
if(!I)throw U=new pv("INVALID_ENCODER_VERSION",{u3:U}),g.b(U),U;return I},FD6=function(I,U){for(const t of I.observers)t(U)},Nc=async function(I,U,t){var W=await csx(I.token);
let E;U=await g.Bi(W,["EntityStore","EntityAssociationStore"],U,Z=>{E=new Qne(Z,I.B);return t(E)});
E&&(W=E.D,Object.keys(W).length>0&&(I.channel.postMessage(W),FD6(I,W)));return U},JF=function(I,U,t){return Nc(I,{mode:"readwrite",
x$:!0},W=>j9(W,U,t))},fYe=function(I,U){return Nc(I,{mode:"readwrite",
x$:!0},t=>AF(t,U,"offlineOrchestrationActionWrapperEntity"))},o6=function(I,U){return Nc(I,{mode:"readwrite",
x$:!0},t=>sA(t,U))},jnx=function(I){return Nc(I,{mode:"readwrite",
x$:!0},U=>a6(U,"videoPlaybackPositionEntity"))},Xc=function(I,U,t){return Nc(I,{mode:"readonly",
x$:!0},W=>yO(W,U,t))},iB=function(I,U,t){return Nc(I,{mode:"readonly",
x$:!0},W=>Fc(W,U,t))},aYY=async function(){try{const U=await g.dD();
if(U&&g.SN()&&typeof g.k5.BroadcastChannel!=="undefined"){var I=new Ask;return new snw(U,I)}}catch(U){U instanceof Error&&g.b(U)}},kx=function(){Yx||(Yx=aYY());
return Yx},NmQ=function(I){I=I.options?.persistenceOption;
return I==="ENTITY_PERSISTENCE_OPTION_PERSIST"||I==="ENTITY_PERSISTENCE_OPTION_INMEMORY_AND_PERSIST"},JsL=async function(I){const U=await kx();
U&&await Nc(U,"readwrite",t=>{const W={};for(const E of I){if(!E.entityKey||!NmQ(E))continue;const Z=g.T6(E.payload);let H=void 0;E.type==="ENTITY_MUTATION_TYPE_REPLACE"&&(H=()=>j9(t,E.payload[Z],Z));
E.type==="ENTITY_MUTATION_TYPE_DELETE"&&(H=()=>sA(t,E.entityKey));
E.type==="ENTITY_MUTATION_TYPE_UPDATE"&&(H=()=>ysY(t,E.entityKey,E.payload[Z],Z));
H&&(W[E.entityKey]=W[E.entityKey]?W[E.entityKey].then(H):H())}return g.xG.all(Object.values(W))})},DT=async function(I){!(I=I.mutations)||I.length<=0||(g.t2&&g.t2.dispatch(KDV({type:"ENTITY_LOADED",
payload:I})),await JsL(I),I.length=0)},oPL=function(I){return I!==void 0},Xhw=function(I){var U=g.iC();
U=Object.assign({},U);I=Object.assign({},I);for(const t in U)I[t]?(U[t]!==4&&(U[t]=I[t]),delete I[t]):U[t]!==2&&(U[t]=4);Object.assign(U,I);g.tfl(U);JSON.stringify(U);return U},ikt=async function(I){const U=await g.dD();
return U?g.Bi(await g.DR(U),["index","media","captions"],{mode:"readwrite",x$:!0},t=>{const W=IDBKeyRange.bound(I+"|",I+"~");t=[t.objectStore("index").delete(W),t.objectStore("media").delete(W),t.objectStore("captions").delete(W)];return g.xG.all(t).then(()=>{})}):void 0},YLL=async function(){const I=await g.dD();
if(!I)throw g.Ds("rvdfd");return g.Bi(await g.DR(I),["index","media"],{mode:"readwrite",x$:!0},U=>{const t={};return g.V9(U.objectStore("index"),{},W=>{var E=W.cursor.key.match(/^([\w\-_]+)\|(a|v)$/);let Z=g.xG.resolve(void 0);if(E){const H=E[1];E=E[2];t[H]=t[H]||{};t[H][E]=g.HaS(W.getValue()?.fmts)}else Z=W.delete().then(()=>{});
return g.xG.all([g.MB(W),Z]).then(([H])=>H)}).then(()=>{const W={};
for(const Z of Object.keys(t)){const H=t[Z].v;W[Z]=t[Z].a&&H?1:2}const E=Xhw(W);return g.JP_(U.objectStore("media"),{},Z=>{const H=Z.cursor.key.match(g.KcG);H&&W[H[1]]||U.objectStore("media").delete(Z.cursor.key);return g.FGS(Z)}).then(()=>E)})})},k2H=async function(I,U){var t=await g.dD();
if(!t)throw g.Ds("wct");t=await g.DR(t);await g.Bi(t,["captions"],{mode:"readwrite",x$:!0},W=>{const E=[];W=W.objectStore("captions");for(let Z=0;Z<U.length;Z++){const H=W.put(U[Z],I+"|"+U[Z].metadata.vss_id);E.push(H)}return g.xG.all(E)})},Dgw=async function(I){I=IDBKeyRange.bound(I+"|",I+"~");
const U=await g.dD();if(!U)throw g.Ds("gactfv");return(await g.DR(U)).getAll("captions",I)},xgt=async function(I){g.kW(I,0);
return ikt(I)},rsH=function(I){return{context:g.wK(),
videoIds:I}},G2V=function(I){return{context:g.wK(),
playlistIds:I}},qLH=function(I){return{context:g.wK(),
offlinePlaylistSyncChecks:I}},bk$=function(){xx||(xx=new exY);
return xx},BmL=function(I,U){return{eventType:{flowEventNamespace:"FLOW_EVENT_NAMESPACE_OFFLINE_ORCHESTRATION",
flowEventType:I},metadata:U,statusCode:void 0,csn:void 0,can:void 0}},Tmx=function(I,U,t){t||(t=I.B.get("FLOW_TYPE_OFFLINE_ORCHESTRATION"),t||(t=g.hj(16),I.B.set("FLOW_TYPE_OFFLINE_ORCHESTRATION",t)));
I={flowNonce:t,flowType:"FLOW_TYPE_OFFLINE_ORCHESTRATION",flowEventType:U.eventType};U.metadata&&(I.flowMetadata=U.metadata);U.statusCode!==void 0&&(I.flowEventStatus=U.statusCode);U.csn&&(I.csn=U.csn);U.can&&(I.can=U.can);g.hu("flowEvent",I,void 0)},RxL=async function(I){var U=await Nc(I,{mode:"readonly",
x$:!0},u=>Fc(u,"playbackData").then(z=>{var y=z.map(k=>k.transfer).filter(k=>!!k),a=z.map(k=>k.offlineVideoPolicy).filter(k=>!!k),Y=z.filter(k=>!!k.key).map(k=>g.nN(g.Oo(k.key).entityId,"downloadStatusEntity"));
y=Fc(u,"transfer",y);a=Fc(u,"offlineVideoPolicy",a);Y=Fc(u,"downloadStatusEntity",Y);const N=y.then(k=>{k=k.reduce((G,Ec)=>{Ec?.offlineVideoStreams&&G.push(...Ec.offlineVideoStreams);return G},[]).filter(G=>!!G);
return Fc(u,"offlineVideoStreams",k)});
return g.xG.all([y,a,N,Y]).then(([k,G,Ec,wA])=>[z,k,G,Ec,wA])}));
I=await Nc(I,{mode:"readonly",x$:!0},u=>Fc(u,"mainDownloadsListEntity").then(z=>z[0]?.downloads??[]));
const [t,W,E,Z,H]=U,w={},l={},d={},K={},v={};U=[];for(var c of W)c&&(w[c.key]=c);for(const u of E)u&&(l[u.key]=u);for(const u of H)u&&(d[u.key]=u);for(const u of Z)u&&(K[u.key]=u);for(const u of I)v[u.videoItem??""]=!0,u.videoItem&&(c=g.Oo(u.videoItem)?.entityId??"",U.push({externalVideoId:c}));return{offlineVideos:t.filter(u=>{if(!u||!u.key||!u.offlineVideoPolicy)return!1;u=g.Oo(u.key).entityId;u=g.nN(u,"downloadStatusEntity");return!(u&&d[u]?.downloadState==="DOWNLOAD_STATE_USER_DELETED")}).map(u=>
{var z=w[u.transfer];
const y=[];if(z?.offlineVideoStreams)for(var a of z.offlineVideoStreams){var Y=K[a];Y&&y.push(Y)}a=l[u.offlineVideoPolicy];Y=u?.playerResponseTimestamp;var N=g.Oo(a.key).entityId;u=g.nN(N,"mainVideoEntity");if(a.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"){var k="OFFLINE_VIDEO_STATE_DISABLED";a.expirationTimestamp&&Number(a.expirationTimestamp)<Date.now()/1E3&&(k="OFFLINE_VIDEO_STATE_EXPIRED")}else if(a.action==="OFFLINE_VIDEO_POLICY_ACTION_DOWNLOAD_FAILED")k="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";
else{switch(z?.transferState){case "TRANSFER_STATE_TRANSFER_IN_QUEUE":k="OFFLINE_VIDEO_STATE_PENDING";break;case "TRANSFER_STATE_TRANSFERRING":k="OFFLINE_VIDEO_STATE_TRANSFERRING";break;case "TRANSFER_STATE_PAUSED_BY_USER":k="OFFLINE_VIDEO_STATE_PAUSED_TRANSFER";break;case "TRANSFER_STATE_FAILED":k="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";break;case "TRANSFER_STATE_COMPLETE":k="OFFLINE_VIDEO_STATE_PLAYABLE";break;case "TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH":k="OFFLINE_VIDEO_STATE_STREAMS_OUT_OF_DATE";
break;default:k="OFFLINE_VIDEO_STATE_UNKNOWN"}if(k==="OFFLINE_VIDEO_STATE_OFFLINE_FAILED")switch(z?.failureReason){case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":k="OFFLINE_VIDEO_STATE_OUT_OF_STORAGE_ERROR";break;case "TRANSFER_FAILURE_REASON_STREAM_MISSING":k="OFFLINE_VIDEO_STATE_STREAMS_MISSING";break;case "TRANSFER_FAILURE_REASON_NETWORK":case "TRANSFER_FAILURE_REASON_NETWORK_LOST":k="OFFLINE_VIDEO_STATE_NETWORK_ERROR"}}N={id:N,videoState:k};
z?.cotn&&(N.cotn=z.cotn);z?.maximumDownloadQuality&&(N.selectedVideoQuality=z?.maximumDownloadQuality);z?.lastProgressTimeMs&&(N.lastProgressTimeMs=z.lastProgressTimeMs);Y&&(N.playerResponseSavedTimeMs=String(Number(Y)*1E3));z=String;Y=0;for(const G of y)if(G.streamsProgress)for(const Ec of G.streamsProgress)Y+=Number(Ec.numBytesDownloaded??0);N.downloadedBytes=z(Y);N.selectedOfflineMode=v[u]?"OFFLINE_MODE_TYPE_AUTO_OFFLINE":"OFFLINE_NOW";a.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"&&(N.offlinePlaybackDisabledReason=
a.offlinePlaybackDisabledReason);return N}),
additionalOfflineClientState:{mainAppAdditionalOfflineClientState:{smartDownloadVideos:U}}}},nPk=function(){try{let t=g.ql("ytglobal.locks_");
if(t)return t;var I;if(I=navigator){var U=navigator;I="locks"in U&&!!U.locks}if(I)return g.k5.localStorage&&g.k5.localStorage.getItem("noop"),t=new Okk,g.DH("ytglobal.locks_",t),t}catch{}},rk=function(I){if(I.includes(":"))throw Error(`Invalid user cache name: ${I}`);
return`${I}:${g.hM("CacheStorage get")}`},VEf=async function(){return G4!==void 0?G4:G4=new Promise(async I=>{try{await qc.open("test-only"),await qc.delete("test-only")}catch(U){if(U instanceof Error&&U.name==="SecurityError"){I(!1);
return}}I("caches"in window)})},bB=async function(){if(await VEf())return e9||(e9=new MEH),e9},BB=function(I,U,t){g.ae(new g.Lm(`Woffle: ${I}`,t?{cotn:t}:""));
U instanceof Error&&g.ae(U)},PD8=async function(I){I=await RxL(I);
g.hu("offlineStateSnapshot",I)},T4=function(I,U){g.Of(I.api,"onOfflineOperationFailure",U);
I.B?.postMessage(U)},I6t=function(I){if(!I.D&&!I.B){var U=nPk();
if(U){I.D=!0;var t=g.hM("OfflineLockManager");U.request(`${"woffle_orchestration_leader"}:${t}`,{},async()=>{try{I.J=new g.lq,I.B=!0,I.D=!1,await I.U(),await I.J.promise}catch(W){I.q4(),W instanceof Error&&(W.args=[{name:"WoLockManagerError",sf:W.name}],g.b(W))}})}}},R6=function(I){I.V&&I.G&&I.T&&I.visibility.isBackground()?I.A.cL(6E4):I.A.stop()},U0t=function(I){I.B&&(I.T=!0,R6(I))},t0w=function(I,U){I.B&&(I.G=U,R6(I))},WG$=function(I,U){I.B&&(I.V=U,R6(I))},OA=function(I){I.offlineDeleteReason=I.offlineDeleteReason??
"OFFLINE_DELETE_REASON_UNKNOWN";
I.offlineModeType=I.offlineModeType??"OFFLINE_NOW";g.hu("offlineDeleteEvent",I)},nv=function(I,{videoId:U,
GV:t,offlineModeType:W}){I.encryptedVideoId=U;I.cotn=t?.cotn;I.offlineabilityFormatType=t?.maximumDownloadQuality;I.isRefresh=t?.isRefresh??!1;I.softErrorCount=t?.transferRetryCount??0;I.offlineModeType=W??"OFFLINE_NOW";(I.transferStatusType==="TRANSFER_STATUS_TYPE_UNKNOWN"&&I.statusType==="UNKNOWN_STATUS_TYPE"||!I.transferStatusType&&!I.statusType)&&g.ae(Error("Woffle unknown transfer status"));g.hu("offlineTransferStatusChanged",I)},Eyf=function(I,U,t,W){W={transferStatusType:"TRANSFER_STATUS_TYPE_PROCESSING",
statusType:"OFFLINING_STARTED",transferFirstStarted:!!W};U&&t&&(U=Math.floor(U/1024).toFixed(),t=Math.floor(t/1024).toFixed(),W.alreadyDownloadedKbytes=U,W.totalFetchedKbytes=U,W.totalContentKbytes=t);nv(W,I)},ZIt=function(I){nv({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_USER_PAUSE",
statusType:"SUSPENDED"},I)},HIw=function(I){switch(I){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":return"OFFLINE_DATABASE_ERROR";
case "TRANSFER_FAILURE_REASON_PLAYABILITY":return"NOT_PLAYABLE";case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":return"TOO_MANY_RETRIES";case "TRANSFER_FAILURE_REASON_INTERNAL":return"OFFLINE_DOWNLOAD_CONTROLLER_ERROR";case "TRANSFER_FAILURE_REASON_STREAM_MISSING":return"STREAM_VERIFICATION_FAILED";case "TRANSFER_FAILURE_REASON_SERVER":case "TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING":return"OFFLINE_REQUEST_FAILURE";case "TRANSFER_FAILURE_REASON_NETWORK":return"OFFLINE_NETWORK_ERROR";default:return"UNKNOWN_FAILURE_REASON"}},
VO=function(I){return(I.actionMetadata?.retryScheduleIntervalsInSeconds?.length??0)>0},Mc=function(I){return I.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD"&&!!I.entityKey},PB=function(I){return I.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&!!I.entityKey},Ir=function(I){return I.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&!!I.entityKey},wHw=function(I){return I.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE"&&!!I.entityKey},Uk=async function(I,U,t,W,E=!1){const Z=
g.nN(I,U),H=g.nN(I,"downloadStatusEntity");
I=await Nc(t,{mode:"readonly",x$:!0},l=>g.xG.all([yO(l,Z,U),yO(l,H,"downloadStatusEntity")]));
const w=I.length?I[0]:void 0;if(w){let l=I.length>1?I[1]:void 0;if(l){if(l.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&!E)return;l.downloadState=W}else l={key:H,downloadState:W};g.DP(w,l6w,l);await Nc(t,{mode:"readwrite",x$:!0},d=>g.xG.all([j9(d,w,U),j9(d,l,"downloadStatusEntity")]))}},t7=function(I,U){return I.actionType===U.actionType&&I.entityKey===U.entityKey},W2=function(I,U){if(I&&I.transferState!=="TRANSFER_STATE_COMPLETE"&&I.transferState!=="TRANSFER_STATE_FAILED"){const t=g.Oo(I.key).entityId;
nv({transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_BY_USER",statusType:"CANCELLED"},{videoId:t,GV:I,offlineModeType:U})}},Ek=function(I){if(!I||!I.thumbnails)return[];
const U=[];for(const t of I.thumbnails)t.url&&U.push(t.url);return U},Z$=async function(I,U,t=[]){if(!t.length)return[];
U=await iB(I,U);I=new Set;for(var W of U)if(U=W.id||W.key)U=g.Oo(U).entityId,I.add(U);W=[];for(const E of t)t=E.offlineVideoData,t?.videoId&&!I.has(t.videoId)&&W.push(E);return W},H2=function(I,U,t){return new g.S2(I,{cotn:U,
raw_player_response:t,download_media:!0,start:Infinity,disable_watch_next:!0})},wF=function(){return{priority:1,
retryScheduleIntervalsInSeconds:[1,2,4]}},dF=function(I){if(!I.key)throw Error("Entity key is required.");
if(!I.actionProto)throw Error("OfflineOrchestrationAction is required.");const U=g.Oo(I.key),t=g.Oo(I.actionProto.entityKey);return new l3(t.entityType,U.entityId,I.actionProto,I.parentActionId,I.rootActionId,I.childActionIds,I.prereqActionId,I.postreqActionIds,I.retryScheduleIndex,I.hasChildActionFailed,Number(I.enqueueTimeSec)*1E3)},Kc=function(I){return{key:g.nN(I.actionId,"offlineOrchestrationActionWrapperEntity"),
actionProto:I.action,parentActionId:I.parentActionId,rootActionId:I.rootActionId,childActionIds:I.childActionIds,prereqActionId:I.prereqActionId,postreqActionIds:I.postreqActionIds,retryScheduleIndex:I.retryScheduleIndex,hasChildActionFailed:I.hasChildActionFailed,enqueueTimeSec:(I.B/1E3).toFixed()}},d06=async function(){const I=await bB();
return I?I.delete("yt-player-local-img"):!0},v2=async function(I){const U=await bB();
if(!U)throw Error("Cache API not supported");if(I.length){var t=await U.open("yt-player-local-img");await Promise.all(I.map(W=>t.delete(W)))}},c2=async function(I){const U=await bB();
if(!U)throw Error("Cache API not supported");I.length&&await (await U.open("yt-player-local-img")).addAll(I)},$K=async function(I,U,t,W,E){const Z=g.nN(I,"mainVideoEntity"),H=g.nN(I,"ytMainChannelEntity"),w=g.nN(I,"transfer"),l=g.nN(I,"videoDownloadContextEntity");
var d=await Nc(U,{mode:"readonly",x$:!0},k=>g.xG.all([yO(k,Z,"mainVideoEntity"),yO(k,H,"ytMainChannelEntity"),yO(k,w,"transfer"),yO(k,l,"videoDownloadContextEntity"),Fc(k,"ytMainChannelEntity"),Fc(k,"offlineOrchestrationActionWrapperEntity")]));
const [K,v,c,u,z,y]=d;if(K||v){d=K?Ek(K.thumbnail):[];var a=v?await KGQ(v,z):[];await v2(d.concat(a))}const Y=[],N=g.nN(I,"downloadStatusEntity");for(const k of y)d=g.Oo(k.key).entityId,a=dF(k),a=g.Oo(a.action.entityKey).entityId,d!==I&&a!==I||t7(t,k.actionProto)||Y.push(k.key);await Nc(U,{mode:"readwrite",x$:!0},k=>{const G=Y.map(Ec=>sA(k,Ec));
G.push(sA(k,Z,{vz:!0}));G.push(sA(k,N,{vz:!0}));return g.xG.all(G)});
I=u?.offlineModeType;E&&(OA(E),E.offlineModeType&&(I=E.offlineModeType));W2(c,I);T4(W,{entityKey:Z,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},u3=async function(I,U,t,W){const E=g.nN(I,"mainPlaylistEntity"),Z=g.nN(I,"ytMainChannelEntity");
var H=await Nc(U,{mode:"readonly",x$:!0},k=>g.xG.all([yO(k,E,"mainPlaylistEntity"),yO(k,Z,"ytMainChannelEntity"),Fc(k,"mainPlaylistEntity"),Fc(k,"mainDownloadsListEntity"),Fc(k,"ytMainChannelEntity"),Fc(k,"offlineOrchestrationActionWrapperEntity")]));
const [w,l,d,K,v,c]=H;if(w||l){H=w?vy0(w):[];var u=l?await KGQ(l,v):[];await v2(H.concat(u))}H=[];u=new Map;if(w){H=await cP6(w,d,K);for(var z of H)u.set(z,{videoId:z,playlistId:I,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});z=await Nc(U,{mode:"readonly",x$:!0},Ec=>g.xG.all([Fc(Ec,"transfer"),Fc(Ec,"videoDownloadContextEntity")]));
const [k,G]=z;for(var y of k)z=g.Oo(y.key).entityId,(z=u.get(z))&&y&&(z.cotn=y.cotn);for(var a of G)y=g.Oo(a.key).entityId,(y=u.get(y))&&a&&(y.offlineModeType=a.offlineModeType)}const Y=[];for(const k of c)a=g.Oo(k.key).entityId,y=dF(k),a!==I&&y.rootActionId!==I||t7(t,k.actionProto)||Y.push(k.key);const N=g.nN(I,"mainPlaylistEntity");await Nc(U,{mode:"readwrite",x$:!0},k=>{const G=Y.map(Ec=>sA(k,Ec));
G.push(sA(k,N,{vz:!0}));return g.xG.all(G)});
if(w&&(H.reverse(),H))for(const k of H)await $K(k,U,t,W,u.get(k))},h7=async function(I,U,t,W){const E=g.nN("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),Z=new Map;
I=await Nc(I,{mode:"readwrite",x$:!0},H=>{const w=Fc(H,"transfer"),l=Fc(H,"offlineOrchestrationActionWrapperEntity"),d=Fc(H,"videoDownloadContextEntity"),K=yO(H,E,"mainDownloadsListEntity");return g.xG.all([w,l,d,K]).then(([v,c,u,z])=>{const y=$06.map(a=>a6(H,a));
for(const a of c)t7(U,a.actionProto)||y.push(sA(H,a.key,{vz:!0}));z&&(z.downloads=[],y.push(j9(H,z,"mainDownloadsListEntity")));if(u)for(const a of u)c=g.Oo(a.key).entityId,c=g.nN(c,"transfer"),Z.set(c,a.offlineModeType);return g.xG.all(y).then(()=>v)})});
for(const H of I){W2(H,Z.get(H.key));I=g.Oo(H.key).entityId;const w={videoId:I,offlineDeleteReason:W,cotn:H.cotn,offlineModeType:Z.get(H.key)};OA(w);I=g.nN(I,"mainVideoEntity");T4(t,{entityKey:I,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})}await d06()},vy0=function(I,U){let t=[];
if(I.thumbnailStyleData)for(const W of I.thumbnailStyleData)t=t.concat(Ek(W?.value?.collageThumbnail?.coverThumbnail));I=Ek(U);return t.concat(I)},cP6=async function(I,U,t){const W=[],E=new Set;
if(t.length)for(var Z of t)if(Z.downloads?.length)for(const H of Z.downloads)H.videoItem&&(t=g.Oo(H.videoItem).entityId,E.add(t));if(I.videos){for(const H of I.videos)Z=JSON.parse(g.Oo(H).entityId),Z.videoId&&!E.has(Z.videoId)&&W.push(Z.videoId);for(const H of U)if(H.key!==I.key&&(U=H.videos))for(const w of U)U=JSON.parse(g.Oo(w).entityId),U.videoId&&(U=W.indexOf(U.videoId),U!==-1&&W.splice(U,1))}return W},KGQ=async function(I,U){const t=Ek(I.avatar);
for(const W of U)if(W.id!==I.id)for(const E of Ek(W.avatar))U=t.indexOf(E),U!==-1&&t.splice(U,1);return t},usw=async function(I){const U=g.Q(I.frameworkUpdates,Ss);
I.frameworkUpdates&&U&&await DT(U)},SBf=function(I){if(I.onResponseReceivedActions?.length&&(I=g.Q(g.Q(I.onResponseReceivedActions[0],hGH),g.EB3)?.actions,I?.length))return I},zGt=async function(I){if(!I)return[];
I=await Xc(I,g.ex,"mainDownloadsListEntity");return I?.downloads?.length?I.downloads.map(U=>U.videoItem??""):[]},zw=async function(I,U){const t=await LGV(I,U);
t&&await Nc(I,{mode:"readwrite",x$:!0},W=>{const E=[j9(W,t.mainDownloadsLibraryEntity,"mainDownloadsLibraryEntity")];t.mainDownloadsListEntity&&E.push(j9(W,t.mainDownloadsListEntity,"mainDownloadsListEntity"));return g.xG.all(E)})},LGV=async function(I,U){const t=g.nN("main_downloads_library_id","mainDownloadsLibraryEntity"),W=g.nN("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
I=await Nc(I,{mode:"readonly",x$:!0},l=>g.xG.all([yO(l,t,"mainDownloadsLibraryEntity"),yO(l,W,"mainDownloadsListEntity")]));
let [E,Z]=I;I=E;let H=Z;I||(I={id:t});for(const l of U)if(l===g.ex){if(I.smartDownloadsList)return;I.smartDownloadsList=l}else{var w=g.Oo(l).entityType;U={};w==="mainPlaylistEntity"?U.playlistItem=l:w==="mainVideoEntity"&&(U.videoItem=l);if(!g.tD(U)){if(H?.downloads){w=!1;for(const d of H.downloads)if(d.playlistItem===l||d.videoItem===l){w=!0;break}w||H.downloads.push(U)}else H={id:W,downloads:[U]};I.downloadsList=W}}return{mainDownloadsLibraryEntity:I,mainDownloadsListEntity:H}},Lc=async function(I,
U){const t=g.nN("main_downloads_library_id","mainDownloadsLibraryEntity"),W=g.nN("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
var E=await Nc(I,{mode:"readonly",x$:!0},l=>g.xG.all([yO(l,t,"mainDownloadsLibraryEntity"),yO(l,W,"mainDownloadsListEntity"),yO(l,g.ex,"mainDownloadsListEntity")]));
const [Z,H,w]=E;if(Z){if(U===g.ex&&w?.downloads)w.downloads=[];else if(H?.downloads){E=g.Oo(U).entityType;for(let l=0;l<H.downloads.length;l++){const d=H.downloads[l];if(E==="mainVideoEntity"&&d.videoItem===U){H.downloads.splice(l,1);break}else if(E==="mainPlaylistEntity"&&d.playlistItem===U){H.downloads.splice(l,1);break}}}await Nc(I,{mode:"readwrite",x$:!0},l=>{const d=[j9(l,Z,"mainDownloadsLibraryEntity")];H&&d.push(j9(l,H,"mainDownloadsListEntity"));w&&d.push(j9(l,w,"mainDownloadsListEntity"));
return g.xG.all(d)})}},pc=async function(I,U){const t=g.nN(U,"transfer"),W=g.nN(U,"videoDownloadContextEntity");
I=await Nc(I,{mode:"readonly",x$:!0},H=>g.xG.all([yO(H,t,"transfer"),yO(H,W,"videoDownloadContextEntity")]));
const [E,Z]=I;return{videoId:U,cotn:E?.cotn,offlineModeType:Z?.offlineModeType}},mO=async function(I,U,t,W,E){const Z=g.nN(I,"musicTrack"),H=g.nN(I,"transfer");
var w=await Nc(U,{mode:"readonly",x$:!0},z=>g.xG.all([yO(z,Z,"musicTrack"),yO(z,H,"transfer"),Fc(z,"musicTrack"),Fc(z,"offlineOrchestrationActionWrapperEntity")]));
const [l,d,K,v]=w;l&&(w=await pHx(l,K),await v2(w));const c=[];for(const z of v){w=g.Oo(z.key).entityId;var u=dF(z);u=g.Oo(u.action.entityKey).entityId;w!==I&&u!==I||t7(t,z.actionProto)||c.push(z.key)}await Nc(U,{mode:"readwrite",x$:!0},z=>{const y=c.map(a=>sA(z,a));
y.push(sA(z,Z,{vz:!0}));return g.xG.all(y)});
W2(d);E&&OA(E);T4(W,{entityKey:Z,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},gF=async function(I,U,t,W,E){const Z=g.nN(I,U),H=g.nN("music_downloads_library_id","musicDownloadsLibraryEntity");
var w=await Nc(t,{mode:"readonly",x$:!0},Y=>g.xG.all([yO(Y,Z,U),yO(Y,H,"musicDownloadsLibraryEntity"),Fc(Y,U),Fc(Y,"offlineOrchestrationActionWrapperEntity")]));
const [l,d,K,v]=w;l&&(w=await pHx(l,K),await v2(w));let c=[];w=new Map;if(l){c=await m00(l,K,d);for(var u of c){const Y=g.Oo(u).entityId;w.set(Y,{videoId:Y,playlistId:I,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"})}u=await iB(t,"transfer");for(var z of u)u=g.Oo(z.key).entityId,(u=w.get(u))&&z&&(u.cotn=z.cotn)}const y=[];for(const Y of v)z=g.Oo(Y.key).entityId,u=dF(Y),z!==I&&u.rootActionId!==I||t7(W,Y.actionProto)||y.push(Y.key);const a=g.nN(I,U);await Nc(t,{mode:"readwrite",x$:!0},
Y=>{const N=y.map(k=>sA(Y,k));
N.push(sA(Y,a,{vz:!0}));return g.xG.all(N)});
if(l&&(c.reverse(),c.length))for(const Y of c)(I=g.Oo(Y).entityId)&&await mO(I,t,W,E,w.get(I))},Cc=async function(I,U,t){I=await Nc(I,{mode:"readwrite",
x$:!0},W=>{const E=Fc(W,"transfer"),Z=Fc(W,"offlineOrchestrationActionWrapperEntity");return g.xG.all([E,Z]).then(([H,w])=>{const l=gyV.map(d=>a6(W,d));
for(const d of w){w=g.Oo(d.actionProto.entityKey).entityType==="musicTrack";const K=d.actionProto.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD";t7(U,d.actionProto)||w&&(!w||K)||l.push(sA(W,d.key,{vz:!0}))}return g.xG.all(l).then(()=>H)})});
for(const W of I)W2(W),I=g.Oo(W.key).entityId,OA({videoId:I,offlineDeleteReason:void 0,cotn:W.cotn}),I=g.nN(I,"musicTrack"),T4(t,{entityKey:I,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"});await d06()},CvY=function(I){let U;
for(const t of I.additionalMetadatas)t.offlineMusicVideoData&&(U=t.offlineMusicVideoData);return{id:g.nN(I.videoId,"musicTrack"),videoId:I.videoId,title:I.title,thumbnailDetails:I.thumbnail,lengthMs:String(Number(I.lengthSeconds)*1E3),albumTitle:U?.releaseTitle,musicVideoType:U?.musicVideoType,contentRating:{explicitType:U?.explicitType},artistNames:U?.byline||U?.channelName,downloadMetadata:g.nN(I.videoId,"musicTrackDownloadMetadataEntity")}},m00=async function(I,U,t){const W=[],E=new Set;
if(t?.downloadedTracks?.length)for(const Z of t.downloadedTracks)E.add(Z);if(I.tracks){for(const Z of I.tracks)E.has(Z)||W.push(Z);for(const Z of U)if(Z.id!==I.id&&(U=Z.tracks))for(const H of U)U=W.indexOf(H),U!==-1&&W.splice(U,1)}return W},pHx=async function(I,U){const t=Ek(I.thumbnailDetails);
for(const W of U)if(W.id!==I.id)for(const E of Ek(W.thumbnailDetails))U=t.indexOf(E),U!==-1&&t.splice(U,1);return t},yg=async function(I,U){var t=g.nN("music_downloads_library_id","musicDownloadsLibraryEntity");
let W=await Xc(I,t,"musicDownloadsLibraryEntity");W||(W={id:t});t=g.Oo(U).entityType;t==="musicTrack"?W.downloadedTracks?.includes(U)||(W.downloadedTracks=(W.downloadedTracks??[]).concat(U)):t==="musicPlaylist"?W.downloadedPlaylists?.includes(U)||(W.downloadedPlaylists=(W.downloadedPlaylists??[]).concat(U)):t!=="musicAlbumRelease"||W.downloadedAlbumReleases?.includes(U)||(W.downloadedAlbumReleases=(W.downloadedAlbumReleases??[]).concat(U));await JF(I,W,"musicDownloadsLibraryEntity")},F1=async function(I,
U){var t=g.nN("music_downloads_library_id","musicDownloadsLibraryEntity");
if(t=await Xc(I,t,"musicDownloadsLibraryEntity")){var W=g.Oo(U).entityType;let E;W==="musicTrack"?E=t.downloadedTracks:W==="musicPlaylist"&&(E=t.downloadedPlaylists);if(E?.length)for(W=0;W<E.length;W++)if(E[W]===U){E.splice(W,1);break}await JF(I,t,"musicDownloadsLibraryEntity")}},yPL=function(I){var U=I.videos;
I=[];const t=[];if(U)for(const E of U){var W=E.offlineVideoData.videoId;U=g.nN(W,"musicTrack");W=g.nN(W,"musicTrackDownloadMetadataEntity");I.push(U);t.push(W)}return{PA:I,CC:t}},Qg=function(I,U,t){U={track:CvY(U)};
t&&(U.playlistId=t);if(I=g.Q(I.actionMetadata,FGY))U.maximumDownloadQuality=I.maximumDownloadQuality;return{musicTrackEntityActionMetadata:U}},f6e=async function(I){var U=g.Uo();
I=rsH(I);const t=g.dK(Q$f);try{var W=await g.Ma(U,I,t,void 0,{kL:!0})}catch(E){if(E instanceof g.qk)throw W=`GetOffline network manager error: ${E.message}`,BB(W,E),Error(W);BB("GetOffline fetch request error",E);throw Error("GetOffline fetch request error");}U=W.errorMetadata?.status;if(!W)throw BB("Network request failed"),Error("Network request failed");if(U!==void 0)fc(U);else if(!W.videos||!W.videos.length)throw BB("No data"),Error("No data");return W.videos.map(E=>E.offlineVideoData)},js=async function(I){var U=
g.Uo();
I=G2V(I);const t=g.dK(Q$f);try{var W=await g.Ma(U,I,t,void 0,{kL:!0})}catch(E){if(E instanceof g.qk)throw W=`GetOffline network manager error for playlist: ${E.message}`,BB(W,E),Error(W);BB("GetOffline fetch request error for playlist",E);throw Error("GetOffline fetch request error for playlist");}U=W.errorMetadata?.status;if(!W)throw BB("Network request failed for playlist"),Error("Network request failed for playlist");if(U!==void 0)fc(U,"playlist");else if(!W.playlists||!W.playlists.length)throw BB("No data for playlist"),
Error("No data for playlist");return W.playlists.map(E=>E.offlinePlaylistData)},APf=async function(I,U,t,W){const E=await kx();
if(!E)return[];var Z=[];W?.length?Z=W:Z=await iB(E,"mainPlaylistEntity");if(!Z.length)return[];W=[];const H=Date.now()/1E3;for(const K of Z){var w=K.downloadState?await Xc(E,K.downloadState,"mainPlaylistDownloadStateEntity"):void 0,l=(Z=K?.entityMetadata)&&Z.nextAutoRefreshIntervalSeconds?Number(Z.nextAutoRefreshIntervalSeconds):NaN;l=Number.isNaN(l)?I:l;var d=w?.lastSyncedTimestampMillis?Number(w?.lastSyncedTimestampMillis)/1E3:0;w=w?.addedTimestampMillis?Number(w?.addedTimestampMillis)/1E3:0;if(t||
!Z||d+l<=H){l=[];if(K.videos?.length)for(const v of K.videos)d=JSON.parse(g.Oo(v).entityId),d.videoId&&l.push(d.videoId);d="0";Z&&(d=String(Number(Z.offlineLastModifiedTimestampSeconds??0).toFixed()));W.push({playlistId:K.playlistId,videoIds:l,offlineLastModifiedTimestamp:d,autoSync:U,offlineDateAddedTimestamp:String(w.toFixed())})}}return W.length?await j$Y(W):[]},s$f=async function(){var I=await kx();
if(!I)return!1;I=await iB(I,"refresh");if(!I[0]?.refreshTime)return!1;I=Number(I[0].refreshTime);const U=Date.now()/1E3;return isFinite(I)&&U>=I},NgH=async function(I,U){let t;
try{const W=await a6H(I,U);await usw(W);t=SBf(W)}catch(W){BB("getAndProcessSmartDownloadsResponse request or processing error",W)}return t},JP0=async function(I,U,t,W){const E=await kx();
if(!E)return[];var Z=[];W?.length?Z=W:Z=await iB(E,"musicPlaylist");if(!Z.length)return[];W=[];const H=Date.now()/1E3;for(const d of Z){var w=(Z=d?.entityMetadata)&&Z.nextAutoRefreshIntervalSeconds?Number(Z.nextAutoRefreshIntervalSeconds):NaN;const K=Number.isNaN(w)?I:w;let v=w=0;var l="DOWNLOAD_SYNC_STATE_UNKNOWN";d.downloadMetadata&&(l=await Xc(E,d.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),w=Number(l?.addedTimestampMillis??"0")/1E3,v=Number(l?.lastModifiedTimestampMillis??"0")/1E3,
l=l?.syncState??"DOWNLOAD_SYNC_STATE_UNKNOWN");if(t||l!=="DOWNLOAD_SYNC_STATE_UP_TO_DATE"||!Z||Number(Z.lastSyncedTimestampSeconds??0)+K<=H){Z=[];if(d.tracks?.length)for(const c of d.tracks)Z.push(g.Oo(c).entityId);W.push({playlistId:d.playlistId,videoIds:Z,offlineLastModifiedTimestamp:String(v.toFixed()),autoSync:U,offlineDateAddedTimestamp:String(w.toFixed())})}}return W.length?await j$Y(W):[]},a6H=async function(I,U){var t=g.Uo(),W=await kx();
let E;W&&(E=await RxL(W));W=E;I={context:g.wK(),browseId:"FEdownloads",browseRequestSupportedMetadata:{downloadsBrowseParams:{offlineFeatureSettingState:{isSdEnabled:I},offlineClientState:W,clientStateRequestData:{preferredFormatType:U}}}};U=g.dK(oye);try{var Z=await g.Ma(t,I,U,void 0,{kL:!0})}catch(H){if(H instanceof g.qk)throw Z=`DPS network manager error for smart downloads: ${H.message}`,BB(Z,H),Error(Z);BB("DPS fetch request error for smart downloads",H);throw Error("DPS fetch request error for smart downloads");
}t=Z.errorMetadata?.status;if(Z)t!==void 0&&fc(t,"smart downloads");else throw BB("Network request failed for smart downloads"),Error("Network request failed for smart downloads");return Z},iIQ=async function(I,U){var t=g.Uo();
I={context:g.wK(),videoPlaybackPositionEntities:I,lastSyncTimestampUsec:U};U=g.dK(XHH);try{var W=await g.Ma(t,I,U,void 0,{kL:!0})}catch(E){if(E instanceof g.qk)throw W=`VPPS network manager error: ${E.message}`,BB(W,E),Error(W);BB("VPPS fetch request error",E);throw Error("VPPS fetch request error");}t=W.errorMetadata?.status;if(W)t!==void 0&&fc(t,"position sync");else throw BB("Network request failed for position sync"),Error("Network request failed for position sync");return W},kO8=async function(I,
U,t){var W=g.Uo(),E=t.refreshData,Z=t.isEnqueuedForExpiredStreamUrlRefetch,H=t.TK,w=t.offlineSourceData;
t=t.mediaCapabilities;I={entityKey:I};E&&(I.refreshData=E);Z&&(I.isExpiredStreamUrlRefetch=Z);H&&(I.downloadParameters=H);w&&(I.offlineSourceData=w);U={context:g.TP(U),signatureTimestamp:20472,videos:[I]};t&&(U.mediaCapabilities=t);E=g.dK(YB8);try{var l=await g.Ma(W,U,E,void 0,{kL:!0})}catch(d){if(d instanceof g.qk)throw l=`GetPDE network manager error: ${d.message}`,BB(l,d),Error(l);BB("GetPDE fetch request error",d);throw Error("GetPDE fetch request error");}W=l.errorMetadata?.status;if(l)W!==void 0&&
fc(W,"PDE");else throw BB("Network request failed for PDE"),Error("Network request failed for PDE");return l},fc=function(I,U){U=U?` for ${U}`:"";
if(I===0)throw I=`Empty response body${U}`,BB(I),Error(I);I=`Response with error${U}`;BB(I);throw Error(I);},j$Y=async function(I){var U=g.Uo();
I=qLH(I);const t=g.dK(D0x);try{var W=await g.Ma(U,I,t,void 0,{kL:!0})}catch(E){if(E instanceof g.qk)throw W=`offlinePlaylistSyncCheck network manager error: ${E.message}`,BB(W,E),Error(W);BB("offlinePlaylistSyncCheck fetch request error",E);throw Error("offlinePlaylistSyncCheck fetch request error");}U=W.errorMetadata?.status;if(!W)throw BB("Network request failed for playlist sync"),Error("Network request failed for playlist sync");if(U!==void 0)fc(U,"playlist sync");else if(!W.offlinePlaylistSyncCheckDatas||
!W.offlinePlaylistSyncCheckDatas.length)throw BB("No data for playlist sync"),Error("No data for playlist sync");return W.offlinePlaylistSyncCheckDatas.map(E=>E.offlinePlaylistSyncCheckData)},x0w=async function(I,U){const t=new Map;
for(const W of U)t.set(W,await I.J(W));return t},A7=function(I,U,t,W,E,Z){U=g.nN(U,t);
return{actionType:I,entityKey:U,actionMetadata:{...Z,priority:W,retryScheduleIntervalsInSeconds:E}}},qB$=async function(I,U){var t=U.entityKey;
const W=g.Q(U.actionMetadata,sk)?.isEnqueuedForExpiredStreamUrlRefetch;try{let Z=void 0;Z=await rPe(I,U);let H;try{{const w=g.Q(U.actionMetadata,sk);var E=w?{maximumDownloadQuality:w.maximumDownloadQuality}:void 0}H=await kO8(t,I.O,{isEnqueuedForExpiredStreamUrlRefetch:W,TK:E,offlineSourceData:Z})}catch(w){const l=VO(U)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";BB("PDE handleAdd error");return ar(U,!1,void 0,
"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",l,"DOWNLOAD_STATE_FAILED")}await GO6(I,H,U);return ar(U,!0,H.orchestrationActions)}catch(Z){return I="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",t="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",Z instanceof g.X4&&Z.type==="QUOTA_EXCEEDED"&&(I="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",t="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),BB("PDE handleAdd error"),ar(U,!1,void 0,I,t,"DOWNLOAD_STATE_FAILED")}},
Bgx=async function(I,U){const t=U.entityKey,W=g.Oo(t).entityId;
var E=await Nc(I.B,{mode:"readonly",x$:!0},v=>{const c=yO(v,t,"playbackData"),u=yO(v,g.nN(W,"offlineVideoPolicy"),"offlineVideoPolicy");v=yO(v,g.nN(W,"transfer"),"transfer");return g.xG.all([c,u,v])});
const [Z,H,w]=E;if(!Z||!H)return ar(U,!0);E=[];var l=Z?.playerResponseJson?JSON.parse(Z.playerResponseJson):null;if(w&&l){var d=eGY(I,l,w);E=await bIk(I,w)}E={lastPlayerResponseTimestampSeconds:Z.playerResponseTimestamp,offlineToken:H.offlineToken,formatIds:E};l={};w?.maximumDownloadQuality&&(l.maximumDownloadQuality=w.maximumDownloadQuality);try{let v=void 0;v=await rPe(I,U);try{var K=await kO8(t,I.O,{refreshData:E,TK:l,offlineSourceData:v,mediaCapabilities:d})}catch(c){const u=VO(U)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":
"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";BB("PDE handleRefresh error");return ar(U,!1,void 0,"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",u,"DOWNLOAD_STATE_FAILED")}await GO6(I,K,U);return ar(U,!0,K.orchestrationActions)}catch(v){return I="PDE handleRefresh error",v instanceof Error&&(I=`PDE handleRefresh error: ${v.message}`),d="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",K="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",v instanceof g.X4&&v.type===
"QUOTA_EXCEEDED"&&(d="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",K="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),BB(I),ar(U,!1,void 0,d,K,"DOWNLOAD_STATE_FAILED")}},rPe=async function(I,U){U=g.Oo(U.entityKey).entityId;
U=g.nN(U,"videoDownloadContextEntity");I=await Xc(I.B,U,"videoDownloadContextEntity");return I?.offlineModeType?{offlineModeType:I.offlineModeType}:void 0},ar=function(I,U,t,W,E,Z){return new Nq(U?"OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS":"OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",VO(I),t,W,E,Z)},GO6=async function(I,U,t){if(U.frameworkUpdates&&g.Q(U.frameworkUpdates,Ss)){if(g.Q(U.frameworkUpdates,Ss).mutations&&g.Q(U.frameworkUpdates,Ss).mutations.length>0&&g.Q(U.frameworkUpdates,Ss).mutations[0].type===
"ENTITY_MUTATION_TYPE_DELETE"){const W=g.Oo(g.Q(U.frameworkUpdates,Ss).mutations[0].entityKey).entityId,E=await pc(I.B,W),Z=g.Q(t.actionMetadata,sk)?.playlistId;
Z&&(E.playlistId=Z);E.offlineDeleteReason="OFFLINE_DELETE_REASON_UNKNOWN";g.Ut(I.O)?await $K(W,I.B,t,I.D,E):g.TD(I.O)&&await mO(W,I.B,t,I.D)}await DT(g.Q(U.frameworkUpdates,Ss))}},eGY=function(I,U,t){U=H2(I.O,t.cotn,U);
t=g.un(U);return g.NvH(U,t,I.O)},bIk=async function(I,U){const t=[];
if(I=await Nc(I.B,{mode:"readonly",x$:!0},W=>{const E=[],Z=U.offlineVideoStreams;if(Z)for(const H of Z)E.push(yO(W,H,"offlineVideoStreams"));return g.xG.all(E)}))for(const W of I)if(W?.streamsProgress){I=W.streamsProgress;
for(let E=0;E<I.length;E++){const Z=JSON.parse(I[E].formatStreamBytes);t.push({itag:Z.itag,lmt:Z.lastModified,xtags:Z.xtags})}}return t},Tg$=async function(I,U){U=VO(U);
I=await iB(I.B,"videoPlaybackPositionEntity");if(I.length===0)return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",U);try{const t=await J7.getInstance();if(!t)throw Error("prefStorage is undefined");const W=(await t.get("psi"))?.hE??"0",E=await iIQ(I,W),Z={isPaused:E.watchHistoryPaused,hE:E.syncTimestampUsec};await t.set("psi",Z);if(!Z.isPaused){const H=g.Q(E.frameworkUpdates,Ss);E.frameworkUpdates&&H&&await DT(H)}}catch(t){return BB("PPE handleRefresh error: "+(t instanceof Error?t.message:
"unknown error")),new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",U,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",U)},OIL=async function(I,U){const t=VO(U),W=g.Oo(U.entityKey).entityId;
try{const E=await J7.getInstance();if(!E)throw Error("prefStorage is undefined");const Z=await E.get("psi"),H=g.Q(U.actionMetadata,RGk);if(Z?.isPaused===!1&&H?.lastPlaybackPositionSeconds){const w={key:g.nN(W,"videoPlaybackPositionEntity"),videoId:W,lastPlaybackPositionSeconds:H.lastPlaybackPositionSeconds};await JF(I.B,w,"videoPlaybackPositionEntity")}}catch(E){return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
t)},nyH=async function(I,U){const t=VO(U);
try{const W=g.Oo(U.entityKey).entityId;if(W==="!*$_ALL_ENTITIES_!*$")await jnx(I.B);else{const E=g.nN(W,"videoPlaybackPositionEntity");await o6(I.B,E)}}catch(W){return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t)},or=async function(I){return xgt(I)},V0k=async function(I){return(await g.weA(I)).filter(U=>!!U.url).map(U=>
U.url)},X1=function(I,U){var t=g.YW(U);
if(t===1||t===0)return Promise.resolve();(t=I.player?.getVideoData().videoId===U?I.player:null)&&t.stopVideo();I.D=0;return or(U)},i3=function(I,U,t=!1,W=!0){U=typeof U==="string"?U:U.videoDetails.videoId;
if(g.YW(U)===2){var E=I.player?.getVideoData().videoId===U?I.player:null;E&&E.stopVideo();g.kW(U,2);I.D=2;t?M0V(I.B):W&&Pv0(I.B)}},U5t=async function(I,U){const t=VO(U);
if(await Xc(I.B,U.entityKey,"transfer"))return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t);try{await Io6(I,U)}catch(W){return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t)},tTH=async function(I,U){const t=VO(U),W=await Xc(I.B,U.entityKey,"transfer");
if(!W||W.transferState!=="TRANSFER_STATE_COMPLETE")return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t);try{await Io6(I,U,!0)}catch(E){return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t)},Wtx=async function(I,U){const t=VO(U),W=g.Oo(U.entityKey).entityId,E=await Nc(I.B,{mode:"readonly",
x$:!0},w=>{const l=yO(w,U.entityKey,"transfer");w=yO(w,g.nN(W,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.xG.all([l,w])}),[Z,
H]=E;if(!Z||Z.transferState!=="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH")return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t);try{Z.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE";await JF(I.B,Z,"transfer");const w=g.Oo(Z.key).entityId;nv({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_PLAYER_RESPONSE_REFRESH"},{videoId:w,GV:Z,offlineModeType:H?.offlineModeType})}catch(w){return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t)},Io6=async function(I,U,t=!1){const W=g.Q(U.actionMetadata,El$),E=g.Oo(U.entityKey).entityId,Z=g.nN(E,"downloadStatusEntity");
var H=await Nc(I.B,{mode:"readonly",x$:!0},K=>{const v=yO(K,Z,"downloadStatusEntity");K=yO(K,g.nN(E,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.xG.all([v,K])});
const [w,l]=H;H="TRANSFER_STATE_TRANSFER_IN_QUEUE";w?.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&(H="TRANSFER_STATE_PAUSED_BY_USER");const d={key:U.entityKey,transferState:H,cotn:g.hj(16),enqueuedTimestampMs:Date.now().toString(),maximumDownloadQuality:W?.maximumDownloadQuality,preferredAudioTrack:W?.preferredAudioTrack,transferRetryCount:0,isRefresh:t,hasLoggedFirstStarted:!1};await Nc(I.B,{mode:"readwrite",x$:!0},K=>{const v=[];t&&v.push(sA(K,g.nN(E,"offlineVideoStreams")));v.push(j9(K,d,"transfer"));
return g.xG.all(v)});
t&&await or(E);nv({transferStatusType:"TRANSFER_STATUS_TYPE_ENQUEUED",statusType:"ADDED_TO_QUEUE"},{videoId:E,GV:d,offlineModeType:l?.offlineModeType})},HFt=function(I,U,t,W){if(!I.action.entityKey)throw Error("entityKey is missing.");
const {VM:E,entityId:Z}=g.Oo(I.action.entityKey),H={entityType:E,entityId:Z,offlineOrchestrationActionType:I.action.actionType,orchestrationAction:{orchestrationActionId:I.actionId}};U&&(H.offlineOrchestrationActionResult=U.status,H.isRetryable=t?!1:U.B,U.D&&(H.offlineOrchestrationFailureReason=ZFQ(U.D,H.isRetryable)));I.action.actionMetadata?.offlineLoggingData?.offlineModeType&&(H.offlineModeType=I.action.actionMetadata.offlineLoggingData.offlineModeType);W&&(H.additionalOrchestrationActions=W.map(w=>
({orchestrationActionId:w.actionId})));
return H},ZFQ=function(I,U){return I!=="OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR"||U?I==="OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"&&U?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":I:"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"},YK=function(I,U){const t={offlineOrchestrationContext:HFt(I)};
U=BmL(U,t);Tmx(bk$(),U,I.rootActionId)},kK=function(I,U,t,W=[]){U={offlineOrchestrationContext:HFt(I,U,t,W)};
U=BmL(3,U);Tmx(bk$(),U,I.rootActionId)},wZw=function(I,U){for(const t of U)YK(t,1),I.actions.push(t);
I.actions.sort(I.B)},loL=function(I,U){if(U)for(let t=0;t<I.actions.length;t++)if(U==="!*$_ALL_ENTITIES_!*$"&&I.actions[t].actionId!==U||U!=="!*$_ALL_ENTITIES_!*$"&&I.actions[t].rootActionId===U&&I.actions[t].actionId!==U)I.actions.splice(t,1),t--},d5H=function(I,U){for(const t of I.actions)if(t.actionId===U)return!0;
return!1},$5x=async function(I,U,t,W,E){I=new KtY(I,U,t,W,E);
await vlx(I);cVx(I);return I},vlx=async function(I){const U=await iB(I.J,"offlineOrchestrationActionWrapperEntity");
await D$(I,U)},cVx=function(I){const U=I.B.actions[0];
return I.A?(U?.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&I.A[0].action.actionType!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(I.T=!0),Promise.resolve()):uN6(I)},uN6=async function(I){if(I.A)throw Error("Already processing an action");
if(!I.Xe()){var U=I.B.actions.shift();t0w(I.mu,!U);if(U!==void 0){U.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&U.actionId==="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS"&&loL(I.B,U.actionId);var t="";U.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&U.rootActionId===U.actionId&&(t=U.actionId);var W=[U];I.A=W;if(U=I.on[U.entityType]){for(const E of W)YK(E,2);try{const E=await x0w(U,W.map(Z=>Z.action));
for(const Z of W){const H=E.get(Z.action);await hix(I,Z,H)}loL(I.B,t)}catch(E){BB("Orchestration error",E);try{await S4w(I,W)}catch(Z){BB("Orchestration retry error",Z);for(const H of W)H.retryScheduleIndex<3&&wZw(I.B,[H])}}finally{I.A=void 0}}else I.A=void 0;await uN6(I)}}},hix=async function(I,U,t){var W=U.retryScheduleIndex+2===3;
if(t.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS"){var E=void 0;try{E=t.A?.map(Z=>I.createAction(Z,U))}catch(Z){kK(U,t,W);
T4(I.V,{entityKey:U.action.entityKey,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_UNSUPPORTED_ENTITY_FAILED"});BB("Orchestration subactions creation error",Z);return}kK(U,t,W,E);if(E){const Z=E.map(w=>Kc(w));
let H=0;for(;H<E.length&&!I.T;)await Nc(I.J,{mode:"readwrite",x$:!0},w=>{const l=[];l.push(AF(w,Z.slice(H,H+10),"offlineOrchestrationActionWrapperEntity"));return g.xG.all(l)}),H+=10;
if(I.T){I.T=!1;return}}t=Kc(U);await o6(I.J,t.key);YK(U,4)}else if(t.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE")if(kK(U,t,W),t.B&&U.retryScheduleIndex+1<3)await S4w(I,[U]);else{W={entityKey:U.action.entityKey,failureReason:t?.J?t.J:"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN"};E=void 0;g.Ut(I.O)?E="mainVideoDownloadStateEntity":g.TD(I.O)&&(E="musicTrackDownloadMetadataEntity");if(E&&t.downloadState){const Z=g.Oo(U.action.entityKey).entityId;await Uk(Z,E,I.J,t.downloadState)}T4(I.V,W);t.downloadState===
"DOWNLOAD_STATE_FAILED"&&I.O.K("html5_auto_retry_failed_pde_actions")||(BB("Orchestration result is not retryable, deleting action"),await o6(I.J,Kc(U).key))}},S4w=async function(I,U){for(const t of U){const W=t.action?.actionMetadata?.retryScheduleIntervalsInSeconds||[1,
2,4];let E=1;t.retryScheduleIndex<W.length&&(E=W[t.retryScheduleIndex]);t.B=E*1E3+Date.now();t.retryScheduleIndex++}await ziw(I,U)},LtH=async function(I,U){return(await iB(I.J,"offlineOrchestrationActionWrapperEntity",U)).filter(oPL)},D$=async function(I,U){let t=[];
var W=Infinity;let E=4E3;for(const H of U){U=Number(H.enqueueTimeSec);const w=pZH(U);var Z=H.retryScheduleIndex;Z=Z!=null&&Z>0;w>0&&Z?(W=Math.min(W,U),E=Math.min(w,E)):t.push(H)}isFinite(W)&&(!I.D.isActive()||W<I.U)&&(I.U=W,I.D.start(E));I.G.oU()||(W=t.length,t=t.filter(H=>!m5L.includes(H.actionProto?.actionType||"OFFLINE_ORCHESTRATION_ACTION_TYPE_UNKNOWN")),W=t.length<W,!I.D.isActive()&&W&&I.D.start(1));
t.length>0&&gle(I,t);await cVx(I)},pZH=function(I){I=I*1E3-Date.now();
return I>4E3?4E3:I},gle=function(I,U){U.length!==0&&U.forEach(t=>{t=dF(t);
t.retryScheduleIndex<3&&wZw(I.B,[t])})},Cjf=async function(I){var U=await LtH(I);
const t=[];for(const W of U)U=g.Oo(W.key).entityId,d5H(I.B,U)||t.push(W);await D$(I,t)},ziw=function(I,U){if(U.length===0)return Promise.resolve([]);
U=U.map(t=>Kc(t));
return fYe(I.J,U)},yVQ=async function(I,U){const t=U.videoId;
let W=!0;if(U.captionTracks.length){const E=lYe(U);I.B=new g.gh(I.xA,U,E)}else if(U.k$)I.B=new g.C0(I.xA,U.k$,t,g.FAc(U),U.rA,U.eventId),W=U.rA;else return;return new Promise(E=>{I.B?.T({Og:async()=>{await I.Og(t,W);E()},
Bt:()=>{}})})},Fte=async function(I){I=await Dgw(I);
return!!I&&I.length>0},Q5x=async function(I,U){if(U.length===0)return[];
const t=U.map(E=>g.nN(E,"transfer")),W=(await iB(I.B,"transfer",t)).filter(oPL).map(E=>g.Oo(E.key).entityId);
I=U.filter(E=>W.indexOf(E)===-1);
if(I.length===0)return[];for(const E of I)await or(E);return I},AV6=async function(I,U,t,W,E,Z){let H="STREAM_TYPE_UNKNOWN";
t.video&&t.audio?(H="STREAM_TYPE_AUDIO_AND_VIDEO",BB("unexpected stream type")):t.video&&!t.audio?H="STREAM_TYPE_VIDEO":!t.video&&t.audio&&(H="STREAM_TYPE_AUDIO");const w=g.nN(U,"offlineVideoStreams"),l={numBytesDownloaded:E.toFixed(),numTotalBytes:Z.toFixed(),streamType:H,streamState:"DOWNLOAD_STREAM_STATE_IN_PROGRESS",formatStreamBytes:JSON.stringify(W),itag:H==="STREAM_TYPE_AUDIO_AND_VIDEO"?Number(t.itag):void 0};await Nc(I,{mode:"readwrite",x$:!0},d=>{const K=yO(d,w,"offlineVideoStreams"),v=yO(d,
g.nN(U,"transfer"),"transfer");return g.xG.all([K,v]).then(([c,u])=>{if(!u)return sA(d,w).then(()=>{});
var z=fo$(c);c=j58(c,W,l,w);const y=j9(d,c,"offlineVideoStreams");fo$(c)>z&&(u.lastProgressTimeMs=Date.now().toString());z=[y];u.offlineVideoStreams||(u.offlineVideoStreams=[]);u.offlineVideoStreams.indexOf(w)===-1&&(u.offlineVideoStreams.push(w),z.push(j9(d,u,"transfer")));return g.xG.all(z)})})},s5k=async function(I,U){U=g.nN(U,"offlineVideoStreams");
if((U=await Xc(I,U,"offlineVideoStreams"))&&U.streamsProgress){for(const t of U.streamsProgress)t.streamState="DOWNLOAD_STREAM_STATE_COMPLETE",t.numTotalBytes!==t.numBytesDownloaded&&(t.numBytesDownloaded=t.numTotalBytes);await JF(I,U,"offlineVideoStreams")}},j58=function(I,U,t,W){if(I&&I.streamsProgress){W=I;
a:{U=`${U.itag};${U.xtags}`;var E=I.streamsProgress;for(let Z=0;Z<E.length;Z++){const H=JSON.parse(E[Z].formatStreamBytes);if(`${H.itag};${H.xtags}`===U){E[Z]=t;t=E;break a}}E.push(t);t=E}W.streamsProgress=t}else I={key:W,streamsProgress:[t]};return I},fo$=function(I){if(I?.streamsProgress){let U=0;
I=I.streamsProgress;for(let t=0;t<I.length;t++){const W=I[t];isNaN(Number(W.numBytesDownloaded))?BB("stream progress bytes number invalid"):U+=Number(W.numBytesDownloaded)}return U}return 0},M0V=async function(I){if(I.B){const U=I.B;
I.A.stop();await xK(I,"TRANSFER_STATE_PAUSED_BY_USER");const t=U?.key?g.Oo(U.key).entityId:"";t&&I.D&&await Uk(t,I.D,I.J,"DOWNLOAD_STATE_PAUSED");const W=await rF(I,t);ZIt({videoId:t,GV:U,offlineModeType:W})}else Gw(I,"onTransferPausedByUser");qq(I);es(I)},Pv0=async function(I){if(I.B){I.A.stop();
await xK(I,"TRANSFER_STATE_TRANSFER_IN_QUEUE");var U=I.B;(U=U?.key?g.Oo(U.key).entityId:"")&&I.D&&await Uk(U,I.D,I.J,"DOWNLOAD_STATE_PAUSED");qq(I)}else Gw(I,"onTransferPausedByNetwork")},b3=async function(I){if(I.B){I.A.start(108E5);
await xK(I,"TRANSFER_STATE_TRANSFERRING");var U=I.B;(U=U?.key?g.Oo(U.key).entityId:"")&&I.D&&await Uk(U,I.D,I.J,"DOWNLOAD_STATE_DOWNLOAD_IN_PROGRESS")}else Gw(I,"onTransferStart")},aok=async function(I,U,t){if(I.B){I.B.transferState!=="TRANSFER_STATE_TRANSFERRING"&&await b3(I);
var W=Date.now();W-I.l0>1E3&&(I.l0=W,await AV6(I.J,t.videoId,t.J,t.pI,t.bytesDownloaded,t.B),!I.C||I.C&&W-I.mu>I.hs)&&(I.mu=W,W=await rF(I,U),Eyf({videoId:U,GV:I.B,offlineModeType:W},t.bytesDownloaded,t.B));I.A.start(108E5)}else Gw(I,`onTransferProgress: ${U}`)},JVH=async function(I){if(I.B){var U=I.B;
I.A.stop();if(U&&I.T){var t=H2(I.api.S(),U.cotn,I.T);await Na6(I,t)}await xK(I,"TRANSFER_STATE_COMPLETE","DOWNLOAD_STREAM_STATE_COMPLETE");(t=U?.key?g.Oo(U.key).entityId:"")&&I.D&&await Uk(t,I.D,I.J,"DOWNLOAD_STATE_COMPLETE");await s5k(I.J,t);var W=await rF(I,t);nv({transferStatusType:"TRANSFER_STATUS_TYPE_COMPLETED",statusType:"SUCCESS"},{videoId:t,GV:U,offlineModeType:W});qq(I);es(I)}else Gw(I,"onTransferComplete")},olH=async function(I){await YLL();
I=I.wk;var U=g.iC();U=Object.keys(U);await Q5x(I,U)},Y4w=async function(I){I=(await iB(I.J,"transfer")).filter(XZY).sort(iFk);
return I.length===0?void 0:I[0]},x5x=async function(I,U){if(!I.U){I.U=!0;
I.B=U;var t=g.Oo(I.B.key).entityId;if(I.B.transferState==="TRANSFER_STATE_TRANSFERRING"){var W=await rF(I,t);nv({transferStatusType:"TRANSFER_STATUS_TYPE_RESUME_PROCESSING",statusType:"OFFLINING_RETRIED"},{videoId:t,GV:I.B,offlineModeType:W})}else I.B.transferState!=="TRANSFER_STATE_TRANSFER_IN_QUEUE"||I.B.transferRetryCount||I.B.hasLoggedFirstStarted||(W=await rF(I,t),I.B.hasLoggedFirstStarted=!0,await kbQ(I),Eyf({videoId:t,GV:I.B,offlineModeType:W},void 0,void 0,!0));await b3(I);t=null;try{t=await D5k(I,
U),I.T=t}catch(E){BB("error getting player response",E,U.cotn);await I.Ke("TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING");return}W=H2(I.api.S(),U.cotn,t);await Na6(I,W);W.Uq=await V0k(W.videoId);t=I.V;U=U.maximumDownloadQuality;W.getPlayerResponse();g.kW(W.videoId,2);t.D=2;t.J=!1;t.player?.dispose();t.player=t.api.K9(W);t.player.r_({localmediachange:t.Gl,signatureexpired:t.e8,statechange:t.A},t);t.K("html5_generate_content_po_token")&&t.player.J6();U=t.oa(U);t.player.Kj(g.Oe(U,U,!0,"m"),!1);t.player.JL(!1);
I.A.start(108E5)}},qq=function(I){I.B=void 0;
I.T=void 0;I.A.stop()},es=async function(I,U=!1){if(I.B)throw Error("Already downloading a video");
I.mu=0;I.U=!1;const t=await Y4w(I);WG$(I.QQ,!t);t&&I.G.oU()?(U&&await new Promise(W=>{g.Ay(W,1E3)}),await x5x(I,t)):!t&&I.B&&qq(I)},rF=async function(I,U){return(await Xc(I.J,g.nN(U,"videoDownloadContextEntity"),"videoDownloadContextEntity"))?.offlineModeType??void 0},rVH=async function(I){I.T&&(await X1(I.V,I.T.videoDetails.videoId),qq(I))},Na6=async function(I,U){try{(U.captionTracks.length||U.k$)&&!await Fte(U.videoId)&&await yVQ(I.qd,U)}catch(t){BB("Caption downloading error",t,U.cotn)}},kbQ=
async function(I,U){if(I.B){var t=I.B;
await Nc(I.J,{mode:"readwrite",x$:!0},W=>{const E=[j9(W,t,"transfer")];U&&E.push(U(W));return g.xG.all(E)})}},D5k=async function(I,U){U=g.Oo(U.key).entityId;
U=g.nN(U,"playbackData");I=await Xc(I.J,U,"playbackData");if(I?.playerResponseJson)return JSON.parse(I.playerResponseJson);throw Error("No PlayerResponse found");},xK=async function(I,U,t,W){if(I.B){I.B.transferState=U;
I.B.failureReason=W;try{await kbQ(I,E=>t?Fc(E,"offlineVideoStreams",I.B.offlineVideoStreams).then(Z=>{for(const H of Z)if(H&&H.streamsProgress)for(const w of H.streamsProgress)w.streamState=t;return AF(E,Z.filter(H=>!!H),"offlineVideoStreams")}):g.xG.resolve(void 0))}catch(E){E instanceof g.X4&&E.type==="QUOTA_EXCEEDED"&&await I.Ke("TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE")}}else Gw(I,`saveTransferState: ${U}`)},Gw=function(I,U){I.api.EJ("woffle",{mcte:U});
BB("missing current transfer entity.")},Gb$=function(I){const U=(I.B.transferRetryCount||0)<3;
U&&(I=I.B,I.transferRetryCount=(I.transferRetryCount||0)+1);return U},q4x=async function(I,U="TRANSFER_FAILURE_REASON_UNKNOWN"){I.B||Gw(I,`setTransferToFailed: ${U}`);
var t="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";U==="TRANSFER_FAILURE_REASON_NETWORK"?t="OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED":U==="TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE"&&(t="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED");await xK(I,"TRANSFER_STATE_FAILED","DOWNLOAD_STREAM_STATE_ERROR_STREAMS_MISSING",U);T4(I.N,{entityKey:I.B?.key,failureReason:t});t=I.B?g.Oo(I.B.key).entityId:"";const W=await rF(I,t);I={videoId:t,GV:I.B,offlineModeType:W};t={transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_WITH_FAILURE",
statusType:"FAILED"};U&&(t.transferFailureReason=U,t.failureReason=HIw(U));nv(t,I)},XZY=function(I){return B2[I.transferState]!==void 0},iFk=function(I,U){const t=B2[I.transferState],W=B2[U.transferState];
return t!==W?t-W:Number(I.enqueuedTimestampMs)-Number(U.enqueuedTimestampMs)},eiQ=async function(I){g.Of(I.api,"onOrchestrationBecameLeader");
await I.jV()},TaY=async function(I){const U=await kx();
if(U){I.J=new bFL(U,I.api,I.D,I.B);var t=I.G(U);I.U=await $5x(U,t,I.D,I.B,I.O);await Ba8(I)}else BB("PES is undefined")},Ba8=async function(I){if(I.J){I.J.B||await es(I.J);
I.O.K("woffle_enable_main_downloads_library")&&await I.Js();I.O.K("html5_offline_playback_position_sync")&&(await I.l0(),await I.Xk(864E5));await I.refreshAllStaleEntities(43200,!0);await I.C();I.O.K("html5_retry_downloads_for_expiration")&&await I.kH();I.mu=g.sJ(()=>{I.refreshAllStaleEntities(43200,!0);I.C()},9E5);
g.L$(g.mR(),()=>I.ul());
var U=await kx();await PD8(U);U0t(I.D)}else BB("transferManager is undefined")},Rik=async function(){const I=await kx();
if(!I)return[];const U=Date.now()/1E3,t=await iB(I,"offlineVideoPolicy");for(const W of t)W.expirationTimestamp&&Number(W.expirationTimestamp)<U&&(W.action="OFFLINE_VIDEO_POLICY_ACTION_DISABLE",W.offlinePlaybackDisabledReason="OFFLINE_PLAYBACK_DISABLED_REASON_CLIENT_OFFLINE_CONTENT_EXPIRED",await JF(I,W,"offlineVideoPolicy"));return t.map(W=>W.key)},Tw=async function(I,U,t,W,E){var Z=await kx();
if(!Z)return[];U=U.map(H=>{var w=g.nN(H,t);w={actionType:W,entityKey:w,actionMetadata:{...wF(),...E}};W!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&(w.actionMetadata.priority=0);H=new l3(t,H,w);return Kc(H)});
Z=fYe(Z,U);I6t(I.D);return Z},OFw=async function(I,U,t,W){const E=[];
for(const Z of U)if(!Z.upToDate&&(!t||Z.shouldAutoSyncMetadata)&&Z.playlistId){U={};switch(W){case "mainPlaylistEntity":U={mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:Z.checkInSeconds,autoSync:t}};break;case "musicPlaylist":U={musicPlaylistEntityActionMetadata:{autoSync:t}}}(U=await Tw(I,[Z.playlistId],W,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",U))&&E.push(...U)}return E},nlV=async function(I,U){if(U.length){const t=wF();
g.DP(t,sk,{isEnqueuedForExpiredStreamUrlRefetch:!0});I.api.EJ("qrd",{v:U.length});return Tw(I,U,"playbackData","OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",t)}return[]},MTY=async function(I,U){const t=VO(U);
var W=g.Oo(U.entityKey).entityId;let E=[];try{E=await VTw(I,W),I.O.K("woffle_enable_main_downloads_library")&&E?.length&&await zw(I.B,[U.entityKey])}catch(H){return U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",H instanceof g.X4&&H.type==="QUOTA_EXCEEDED"?(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"):BB("Playlist add error"),new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
t,void 0,U,W)}const Z=[];I.O.K("html5_offline_prevent_redownload_downloaded_video")&&(E=await Z$(I.B,"mainVideoEntity",E));if(E?.length)for(const H of E)I=H.offlineVideoData,I?.videoId&&Z.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",I.videoId,"mainVideoEntity",Number(U.actionMetadata?.priority||0)+1,Rr,Ok(U,I,W)));return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,Z)},I7f=async function(I,U){const t=VO(U);
var W=U.entityKey,E=g.Oo(W).entityId,Z=[],H=!1;E==="!*$_ALL_ENTITIES_!*$"?(H=!0,Z=await iB(I.B,"mainPlaylistEntity")):(W=await Xc(I.B,W,"mainPlaylistEntity"))&&Z.push(W);if(!Z?.length)return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t);var w=g.Q(U.actionMetadata,Pjk);W=w?.nextAutoRefreshIntervalSeconds;const l=w?.autoSync;let d=[],K=!0;w=!0;let v=!1;if(H||l!==!1){try{d=await APf(0,!!l,!0,Z)}catch(y){y instanceof Error&&y.message==="No data"?E==="!*$_ALL_ENTITIES_!*$"?await h7(I.B,U,I.D,
"OFFLINE_DELETE_REASON_UNAVAILABLE"):await u3(E,I.B,U,I.D):y instanceof Error&&y.message==="Empty response body"&&BB(y.message)}if(!d.length||!H&&d[0].playlistId!==E)return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t)}if(H){U=[];for(var c of d)c.upToDate||l&&!c.shouldAutoSyncMetadata||!c.playlistId||U.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",c.playlistId,"mainPlaylistEntity",0,Rr,{mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:c.checkInSeconds,autoSync:l}}));
return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,U)}d.length&&(c=d[0],v=!!c.upToDate,l&&(K=c.shouldAutoSyncMetadata??!0,w=c.shouldAutoSyncVideos??!0,c.checkInSeconds&&(W=c.checkInSeconds)));if(v||!K)return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t);c=[];Z=Z[0];H=Z.downloadState?await Xc(I.B,Z.downloadState,"mainPlaylistDownloadStateEntity"):void 0;H=H?.addedTimestampMillis?String(H.addedTimestampMillis):void 0;try{c=await VTw(I,E,H,W)}catch(y){if(y instanceof Error&&y.message===
"No data for playlist")await u3(E,I.B,U,I.D);else if(y instanceof Error&&y.message==="Empty response body for playlist")BB(y.message);else return U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",E="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",y instanceof g.X4&&y.type==="QUOTA_EXCEEDED"&&(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",E="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,U,E)}if(!w)return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
t);I=[];W=new Map;if(c?.length)for(var u of c)w=u.offlineVideoData,w?.videoId&&W.set(w.videoId,w);u=new Map;w=[];if(Z?.videos?.length)for(var z of Z.videos)if(Z=JSON.parse(g.Oo(z).entityId).videoId)W.has(Z)?(u.set(Z,W.get(Z)),W.delete(Z)):w.push(Z);z=Number(U.actionMetadata?.priority||0)+1;for(const [y,a]of W.entries())I.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",y,"mainVideoEntity",z,Rr,Ok(U,a,E)));for(const [y,a]of u.entries())I.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",y,"mainVideoEntity",
z,Rr,Ok(U,a,E)));for(const y of w)I.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",y,"mainVideoEntity",0,Rr,{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"},mainVideoEntityActionMetadata:{playlistId:E}}));return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,I)},UXt=async function(I,U){const t=VO(U);
try{const W=g.Oo(U.entityKey).entityId;W==="!*$_ALL_ENTITIES_!*$"?await h7(I.B,U,I.D,U.actionMetadata?.offlineLoggingData?.offlineDeleteReason):(await u3(W,I.B,U,I.D),I.O.K("woffle_enable_main_downloads_library")&&await Lc(I.B,U.entityKey))}catch(W){return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
t)},VTw=async function(I,U,t,W){U=await js([U]);
const {mainPlaylistEntity:E,j1:Z}=await tot(I,U[0],t,W);I=vy0(E,Z?.avatar);try{await c2(I)}catch(H){H instanceof Error&&H.message==="Failed to fetch"&&BB(H.message)}return U[0].videos},Ok=function(I,U,t){U={offlineVideoData:U,
playlistId:t};if(I=g.Q(I.actionMetadata,Pjk))U.maximumDownloadQuality=I.maximumDownloadQuality;return{mainVideoEntityActionMetadata:U}},tot=async function(I,U,t,W){const E=Date.now().toString();
t||(t=E);var Z=U.videos;const H=U.playlistId,w=[],l=[];if(Z)for(const c of Z){Z=c.offlineVideoData;if(!Z||!Z.videoId)throw BB("Invalid offlineVideoData for playlist"),Error("Invalid offlineVideoData for playlist");Z=Z.videoId;Z={id:g.nN(JSON.stringify({videoId:Z,playlistId:H}),"mainPlaylistVideoEntity"),video:g.nN(Z,"mainVideoEntity")};w.push(Z);l.push(Z.id)}let d;const K={key:g.nN(H,"mainPlaylistDownloadStateEntity"),addedTimestampMillis:t,lastSyncedTimestampMillis:E},v={key:g.nN(H,"mainPlaylistEntity"),
playlistId:H,videos:l,title:U.title,thumbnailStyleData:W4k(U),visibility:Ed$(U),downloadState:K.key};U.channel&&(t=U.channel.offlineChannelData,d=ZRY(g.nN(H,"ytMainChannelEntity"),t),v.channelOwner=d.id);v?.entityMetadata?(v.entityMetadata.offlineLastModifiedTimestampSeconds=U.lastModifiedTimestamp,W&&(v.entityMetadata.nextAutoRefreshIntervalSeconds=String(W))):v&&(v.entityMetadata={nextAutoRefreshIntervalSeconds:W?String(W):void 0,offlineLastModifiedTimestampSeconds:U.lastModifiedTimestamp});try{await Nc(I.B,
{mode:"readwrite",x$:!0},c=>{var u=j9(c,v,"mainPlaylistEntity");const z=j9(c,K,"mainPlaylistDownloadStateEntity");u=[u,z];for(const y of w)u.push(j9(c,y,"mainPlaylistVideoEntity"));d&&u.push(j9(c,d,"ytMainChannelEntity"));return g.xG.all(u)})}catch(c){throw BB("PES failure for playlist"),Error("PES failure for playlist");
}return{mainPlaylistEntity:v,j1:d,Hf0:w}},W4k=function(I){const U=[];
var t=I.videos;t&&t.length>0&&U.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_FIRST_VIDEO"),value:{collageThumbnail:{coverThumbnail:t[0].offlineVideoData.thumbnail}}});if((I=I.additionalMetadadatas)&&I.length>0)for(const W of I)switch(I=W.offlineBundleItemPlaylistData,t={collageThumbnail:{coverThumbnail:I?.coverThumbnail}},I?.style){case "BUNDLE_ITEM_STYLE_UNSPECIFIED":U.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_UNKNOWN"),value:t});break;case "BUNDLE_ITEM_STYLE_TWO_BY_TWO":U.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_TWO_BY_TWO"),
value:t});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO_AVATAR":U.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO_AVATAR"),value:t});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO":U.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO"),value:t})}return U},Ed$=function(I){switch(I.privacy){case "PRIVATE":return"PLAYLIST_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_VISIBILITY_UNLISTED";default:return"PLAYLIST_VISIBILITY_UNKNOWN"}},ZRY=function(I,U){return{id:I,
channelId:U.channelId,title:U.title,avatar:U.thumbnail}},l7x=async function(I,U){const t=VO(U);
var W=g.Oo(U.entityKey).entityId;const E=g.Q(U.actionMetadata,nc),Z=!E?.playlistId;try{await HRx(I,W,void 0,E?.offlineVideoData,Z)}catch(H){return W="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",H instanceof g.X4&&H.type==="QUOTA_EXCEEDED"&&(W="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,W,U)}I=Number(U.actionMetadata?.priority||
0)+1;U=(U=g.Q(U.actionMetadata,nc))?{playbackDataActionMetadata:{maximumDownloadQuality:U.maximumDownloadQuality}}:void 0;W=A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",W,"playbackData",I,wye,U);return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,[W])},dX0=async function(I,U){const t=VO(U),W=g.Oo(U.entityKey).entityId;
var E=await Xc(I.B,U.entityKey,"mainVideoEntity"),Z=E?await Xc(I.B,E.downloadState,"mainVideoDownloadStateEntity"):void 0;if(!E||!Z)return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t);let H;try{await HRx(I,W,Z.addedTimestampMillis,g.Q(U.actionMetadata,nc)?.offlineVideoData),E=1,E=Number(U.actionMetadata?.priority||0)+1,H=A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",W,"playbackData",E,wye)}catch(w){if(w instanceof Error&&w.message==="No data"){E=await pc(I.B,W);if(Z=g.Q(U.actionMetadata,
nc)?.playlistId)E.playlistId=Z;E.offlineDeleteReason="OFFLINE_DELETE_REASON_UNAVAILABLE";await $K(W,I.B,U,I.D,E)}else if(w instanceof Error&&w.message==="Empty response body")BB(w.message);else return I="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",w instanceof g.X4&&w.type==="QUOTA_EXCEEDED"&&(I="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
t,void 0,I,U)}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,H?[H]:void 0)},K4$=async function(I,U){const t=VO(U);
try{const W=g.Oo(U.entityKey).entityId;if(W==="!*$_ALL_ENTITIES_!*$")await h7(I.B,U,I.D,U.actionMetadata?.offlineLoggingData?.offlineDeleteReason);else{const E=await pc(I.B,W),Z=g.Q(U.actionMetadata,nc)?.playlistId;Z&&(E.playlistId=Z);E.offlineDeleteReason=U.actionMetadata?.offlineLoggingData?.offlineDeleteReason;await $K(W,I.B,U,I.D,E);I.O.K("woffle_enable_main_downloads_library")&&await Lc(I.B,U.entityKey)}}catch(W){return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t)},HRx=async function(I,U,t,W,E){W||(W=(await f6e([U]))[0]);
const {mainVideoEntity:Z,channelEntity:H}=await vd6(I,W,t,E);try{const w=Ek(Z.thumbnail),l=Ek(H.avatar);await c2(w.concat(l))}catch(w){w instanceof Error&&w.message==="Failed to fetch"&&BB(w.message)}},vd6=async function(I,U,t,W){t||(t=Date.now().toString());
const E=U.channel?.offlineChannelData,Z={id:g.nN(U.videoId,"ytMainChannelEntity"),channelId:E.channelId,title:E.title,avatar:E.thumbnail},H={key:g.nN(U.videoId,"mainVideoDownloadStateEntity"),playbackData:g.nN(U.videoId,"playbackData"),addedTimestampMillis:t,videoDownloadContextEntity:g.nN(U.videoId,"videoDownloadContextEntity")},w={key:g.nN(U.videoId,"videoPlaybackPositionEntity"),videoId:U.videoId,lastPlaybackPositionSeconds:"0"};let l;I.O.K("html5_offline_playback_position_sync")&&(l={playbackPosition:w.key});
t=g.nN(U.videoId,"mainVideoEntity");const d={key:t,videoId:U.videoId,title:U.title,thumbnail:U.thumbnail,localizedStrings:{viewCount:U.shortViewCountText},userState:l,lengthSeconds:U.lengthSeconds?Number(U.lengthSeconds):void 0,publishedTimestampMillis:U.publishedTimestamp?(Number(U.publishedTimestamp)*1E3).toString():void 0,formattedDescription:U.description,owner:Z.id,downloadState:H.key};let K,v;I.O.K("woffle_enable_main_downloads_library")&&W&&(W=await LGV(I.B,[t]))&&(K=W.mainDownloadsLibraryEntity,
v=W.mainDownloadsListEntity);let c;c={key:g.nN(U.videoId,"downloadStatusEntity"),downloadState:"DOWNLOAD_STATE_PENDING_DOWNLOAD"};g.DP(H,l6w,c);await Nc(I.B,{mode:"readwrite",x$:!0},u=>{var z=j9(u,Z,"ytMainChannelEntity"),y=j9(u,H,"mainVideoDownloadStateEntity");const a=j9(u,d,"mainVideoEntity");z=[z,y,a];I.O.K("html5_offline_playback_position_sync")&&(y=j9(u,w,"videoPlaybackPositionEntity"),z.push(y));K&&(y=j9(u,K,"mainDownloadsLibraryEntity"),z.push(y));v&&(y=j9(u,v,"mainDownloadsListEntity"),z.push(y));
c&&(u=j9(u,c,"downloadStatusEntity"),z.push(u));return g.xG.all(z)});
return{mainVideoEntity:d,channelEntity:Z}},$XV=async function(I,U){const t=VO(U),W=[];
var E=await J7.getInstance();let Z,H;E&&(Z=await E.get("sdois"),H=await E?.get("lmqf"));try{if(Z===void 0)throw Error("prefStorage or opt-in state is undefined");E=[];Z||(E=await zGt(I.B),E.reverse());if(E.length)for(const d of E){if(!d)continue;const K=g.Oo(d).entityId,v=await pc(I.B,K);v.offlineDeleteReason="OFFLINE_DELETE_REASON_PARENT_LIST_DELETE";await $K(K,I.B,{entityKey:d,actionType:U.actionType},I.D,v)}const w=await a6H(Z,H??"SD");await usw(w);const l=SBf(w);I.O.K("woffle_enable_main_downloads_library")&&
(Z||await Lc(I.B,g.ex),await zw(I.B,[g.ex]));if(l?.length)for(const d of l){const K=d.actionType,v=d.entityKey,c=d.actionMetadata;if(K&&v&&c&&!g.Q(c,cU6)){K==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(c.offlineLoggingData={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});const u=g.Q(d.actionMetadata,nc);u&&(u.playlistId="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS",d.actionMetadata={...d.actionMetadata,mainVideoEntityActionMetadata:u});W.push(d)}}}catch(w){return I="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",
U="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",w instanceof g.X4&&w.type==="QUOTA_EXCEEDED"&&(I="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,I,U)}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,W)},uIe=async function(I,U=43200,t=!0){if(!I.V.oU())return[];
let W=[];try{W=await APf(U,t,!1)}catch(E){E instanceof Error&&E.message==="No data"||E instanceof Error&&E.message==="Empty response body"&&BB(E.message)}return OFw(I,W,t,"mainPlaylistEntity")},hEw=async function(I,U,t,W=!1){let E=[];
if(!await s$f()&&!W)return[];t=await NgH(U,t);if(!t?.length)return[];U={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"};for(const H of t){t=H.actionType;var Z=H.entityKey;W=H.actionMetadata;t&&Z&&W&&!g.Q(W,cU6)&&(t==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(W.offlineLoggingData=U),{entityId:Z}=g.Oo(Z),t=await Tw(I,[Z],"mainVideoEntity",t,W),E=E.concat(t))}return E},zE6=async function(I,U){const t=VO(U);
var W=g.Oo(U.entityKey).entityId;let E=[];try{E=await SnL(I,W),E?.length&&await yg(I.B,U.entityKey)}catch(H){return U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",H instanceof g.X4&&H.type==="QUOTA_EXCEEDED"&&(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,U,W)}const Z=[];E=await Z$(I.B,"musicTrack",E);if(E.length)for(const H of E)I=
H.offlineVideoData,I?.videoId&&Z.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",I.videoId,"musicTrack",Number(U.actionMetadata?.priority||0)+1,Vg,Qg(U,I,W)));return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,Z)},L4t=async function(I,U){const t=VO(U);
var W=U.entityKey,E=g.Oo(W).entityId,Z=[],H=!1;E==="!*$_ALL_ENTITIES_!*$"?(H=!0,Z=await iB(I.B,"musicAlbumRelease")):(W=await Xc(I.B,W,"musicAlbumRelease"))&&Z.push(W);if(!Z?.length)return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t);if(H){U=[];for(var w of Z){var l=g.Oo(w.id).entityId;U.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",l,"musicAlbumRelease",0,Vg))}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,U)}w=[];Z=Z[0];H=void 0;Z.downloadMetadata&&(H=await Xc(I.B,
Z.downloadMetadata,"musicAlbumReleaseDownloadMetadataEntity"),H=Number(H?.addedTimestampMillis??"0")/1E3);try{w=await SnL(I,E,H?.toString())}catch(v){if(v instanceof Error&&v.message==="No data")await gF(E,"musicAlbumRelease",I.B,U,I.D);else if(v instanceof Error&&v.message==="Empty response body")BB(v.message);else return U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",l="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",v instanceof g.X4&&v.type==="QUOTA_EXCEEDED"&&(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
l="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,U,l)}I=[];E=new Map;if(w?.length)for(var d of w)w=d.offlineVideoData,w?.videoId&&E.set(w.videoId,w);d=new Map;w=[];if(Z?.tracks?.length)for(var K of Z.tracks)if(Z=g.Oo(K).entityId)E.has(Z)?(d.set(Z,E.get(Z)),E.delete(Z)):w.push(Z);K=Number(U.actionMetadata?.priority||0)+1;for(const [v,c]of E.entries())I.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",v,"musicTrack",K,Vg,Qg(U,c)));for(const [v,
c]of d.entries())I.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",v,"musicTrack",K,Vg,Qg(U,c)));for(l of w)I.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",l,"musicTrack",0,Vg));return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,I)},pyQ=async function(I,U){const t=VO(U);
try{const W=g.Oo(U.entityKey).entityId;W==="!*$_ALL_ENTITIES_!*$"?await Cc(I.B,U,I.D):(await gF(W,"musicAlbumRelease",I.B,U,I.D),await F1(I.B,U.entityKey))}catch(W){return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t)},SnL=async function(I,U,t){U=await js([U]);
I=await mX6(I,U[0],t);I=Ek(I.thumbnailDetails);await c2(I);return U[0].videos},mX6=async function(I,U,t){var W=U.additionalMetadadatas;
let E=void 0;if(W&&W.length>0)for(var Z of W)if(Z.offlineMusicPlaylistData){E=Z.offlineMusicPlaylistData;break}W=U.playlistId;const {PA:H,CC:w}=yPL(U);t=t?(Number(t)*1E3).toString():Date.now().toString();Z=U.lastModifiedTimestamp?(Number(U.lastModifiedTimestamp)*1E3).toString():"0";const l={id:g.nN(W,"musicAlbumReleaseDownloadMetadataEntity"),trackDownloadMetadatas:w,lastModifiedTimestampMillis:Z,addedTimestampMillis:t,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},d={id:g.nN(W,"musicAlbumRelease"),
title:U.title,audioPlaylistId:W,trackCount:U.totalVideoCount,tracks:H,downloadMetadata:l.id};E&&(d.thumbnailDetails=E.albumHqThumbnail??E.albumArtistThumbnail,d.artistDisplayName=E.albumArtistDisplayName,d.releaseDate=E.albumReleaseDate,d.contentRating={explicitType:E.albumReleaseExplicitType},d.releaseType=E.albumReleaseType);await Nc(I.B,{mode:"readwrite",x$:!0},K=>{const v=j9(K,d,"musicAlbumRelease");K=j9(K,l,"musicAlbumReleaseDownloadMetadataEntity");return g.xG.all([v,K])});
return d},C2V=async function(I,U){const t=VO(U);
var W=g.Oo(U.entityKey).entityId;let E=[];try{E=await gdQ(I,W),E?.length&&await yg(I.B,U.entityKey)}catch(H){return U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",H instanceof g.X4&&H.type==="QUOTA_EXCEEDED"&&(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,U,W)}const Z=[];E=await Z$(I.B,"musicTrack",E);if(E.length)for(const H of E)I=
H.offlineVideoData,I?.videoId&&Z.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",I.videoId,"musicTrack",Number(U.actionMetadata?.priority||0)+1,Mq,Qg(U,I,W)));return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,Z)},yU6=async function(I,U){const t=VO(U);
var W=U.entityKey,E=g.Oo(W).entityId,Z=[],H=!1;E==="!*$_ALL_ENTITIES_!*$"?(H=!0,Z=await iB(I.B,"musicPlaylist")):(W=await Xc(I.B,W,"musicPlaylist"))&&Z.push(W);if(!Z?.length)return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t);const w=g.Q(U.actionMetadata,FGY)?.autoSync;let l=[],d=!0;W=!0;let K=!1;var v=void 0;if(H||w!==!1){try{l=await JP0(0,!!w,!0,Z)}catch(a){a instanceof Error&&a.message==="No data"?E==="!*$_ALL_ENTITIES_!*$"?await Cc(I.B,U,I.D):await gF(E,"musicPlaylist",I.B,U,I.D):a instanceof
Error&&a.message==="Empty response body"&&BB(a.message)}if(!l.length||!H&&l[0].playlistId!==E)return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t)}if(H){U=[];for(var c of l)c.upToDate||w&&!c.shouldAutoSyncMetadata||!c.playlistId||U.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",c.playlistId,"musicPlaylist",0,Mq,{musicPlaylistEntityActionMetadata:{autoSync:w}}));return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,U)}l.length&&(c=l[0],K=!!c.upToDate,w&&(d=c.shouldAutoSyncMetadata??
!0,W=c.shouldAutoSyncVideos??!0,c.checkInSeconds&&(v=c.checkInSeconds)));if(K||!d)return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t);c=[];Z=Z[0];H=void 0;Z.downloadMetadata&&(H=await Xc(I.B,Z.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),H=Number(H?.addedTimestampMillis??"0")/1E3);try{c=await gdQ(I,E,H?.toString(),v)}catch(a){if(a instanceof Error&&a.message==="No data")await gF(E,"musicPlaylist",I.B,U,I.D);else if(a instanceof Error&&a.message==="Empty response body")BB(a.message);
else{U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";var u="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED";a instanceof g.X4&&a.type==="QUOTA_EXCEEDED"&&(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",u="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE");return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,U,u)}}if(!W)return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t);I=[];E=new Map;if(c?.length)for(var z of c)W=z.offlineVideoData,W?.videoId&&
E.set(W.videoId,W);z=new Map;W=[];if(Z?.tracks?.length)for(var y of Z.tracks)if(v=g.Oo(y).entityId)E.has(v)?(z.set(v,E.get(v)),E.delete(v)):W.push(v);y=Number(U.actionMetadata?.priority||0)+1;for(const [a,Y]of E.entries())I.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",a,"musicTrack",y,Mq,Qg(U,Y)));for(const [a,Y]of z.entries())I.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",a,"musicTrack",y,Mq,Qg(U,Y)));for(u of W)I.push(A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",u,"musicTrack",0,Mq));
return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,I)},F46=async function(I,U){const t=VO(U);
try{const W=g.Oo(U.entityKey).entityId;W==="!*$_ALL_ENTITIES_!*$"?await Cc(I.B,U,I.D):(await gF(W,"musicPlaylist",I.B,U,I.D),await F1(I.B,U.entityKey))}catch(W){return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t)},gdQ=async function(I,U,t,W){U=await js([U]);
I=await QUt(I,U[0],t,W);I=Ek(I.thumbnailDetails);await c2(I);return U[0].videos},QUt=async function(I,U,t,W){const E=U.playlistId,{PA:Z,
CC:H}=yPL(U);t=t?(Number(t)*1E3).toString():Date.now().toString();const w=U.lastModifiedTimestamp?(Number(U.lastModifiedTimestamp)*1E3).toString():"0",l={id:g.nN(E,"musicPlaylistDownloadMetadataEntity"),trackDownloadMetadatas:H,lastModifiedTimestampMillis:w,addedTimestampMillis:t,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},d={id:g.nN(E,"musicPlaylist"),title:U.title,playlistId:E,thumbnailDetails:U.thumbnail,visibility:f7Y(U),trackCount:U.totalVideoCount,tracks:Z,downloadMetadata:l.id};W&&(d?.entityMetadata?
d.entityMetadata.nextAutoRefreshIntervalSeconds=String(W):d&&(d.entityMetadata={nextAutoRefreshIntervalSeconds:String(W)}));await Nc(I.B,{mode:"readwrite",x$:!0},K=>{const v=j9(K,d,"musicPlaylist");K=j9(K,l,"musicPlaylistDownloadMetadataEntity");return g.xG.all([v,K])});
return d},f7Y=function(I){switch(I.privacy){case "PRIVATE":return"PLAYLIST_ENTITY_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_ENTITY_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_ENTITY_VISIBILITY_UNLISTED";default:return"PLAYLIST_ENTITY_VISIBILITY_UNKNOWN"}},sUw=async function(I,U){const t=VO(U);
var W=g.Oo(U.entityKey).entityId;const E=g.Q(U.actionMetadata,P2);try{await jUk(I,W,void 0,E?.track,E?.albumRelease),E?.playlistId||await yg(I.B,U.entityKey)}catch(Z){return U="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",Z instanceof g.X4&&Z.type==="QUOTA_EXCEEDED"&&(U="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,
void 0,U,W)}I=(I=g.Q(U.actionMetadata,P2))?{playbackDataActionMetadata:{maximumDownloadQuality:I.maximumDownloadQuality}}:void 0;U=A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",W,"playbackData",Number(U.actionMetadata?.priority||0)+1,AUf,I);return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,[U])},a7Q=async function(I,U){const t=VO(U),W=g.Oo(U.entityKey).entityId;
var E=await Xc(I.B,U.entityKey,"musicTrack");const Z=E?await Xc(I.B,E.downloadMetadata,"musicTrackDownloadMetadataEntity"):void 0;if(!E||!Z)return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t);let H;E=g.Q(U.actionMetadata,P2);try{await jUk(I,W,Z.addedTimestampMillis,E?.track,E?.albumRelease),H=A7("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",W,"playbackData",Number(U.actionMetadata?.priority||0)+1,AUf)}catch(w){if(w instanceof Error&&w.message==="No data")await mO(W,I.B,U,I.D);else if(w instanceof
Error&&w.message==="Empty response body")BB(w.message);else return I="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",w instanceof g.X4&&w.type==="QUOTA_EXCEEDED"&&(I="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",U="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,I,U)}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t,H?[H]:void 0)},NS0=async function(I,
U){const t=VO(U);
try{const W=g.Oo(U.entityKey).entityId;W==="!*$_ALL_ENTITIES_!*$"?await Cc(I.B,U,I.D):(await mO(W,I.B,U,I.D),await F1(I.B,U.entityKey))}catch(W){return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",t,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new Nq("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",t)},jUk=async function(I,U,t,W,E){W||(W=(await f6e([U]))[0],W=CvY(W));
const {musicTrackEntity:Z,QA:H}=await JU0(I,W,U,E,t);I=Ek(Z.thumbnailDetails);U=[];H&&(U=Ek(H.thumbnailDetails));await c2(I.concat(U))},JU0=async function(I,U,t,W,E){E||(E=Date.now().toString());
const Z={id:g.nN(t,"musicTrackDownloadMetadataEntity"),playbackData:g.nN(t,"playbackData"),addedTimestampMillis:E,videoDownloadContextEntity:g.nN(t,"videoDownloadContextEntity")};W&&(U.albumRelease=W.id);await Nc(I.B,{mode:"readwrite",x$:!0},H=>{const w=[];var l=j9(H,Z,"musicTrackDownloadMetadataEntity");w.push(l);l=j9(H,U,"musicTrack");w.push(l);W&&(H=j9(H,W,"musicAlbumRelease"),w.push(H));return g.xG.all(w)});
await Uk(t,"musicTrackDownloadMetadataEntity",I.B,"DOWNLOAD_STATE_PENDING_DOWNLOAD");return{musicTrackEntity:U,QA:W}},odt=async function(I,U=43200,t=!0){if(!I.V.oU())return[];
let W=[];try{W=await JP0(U,t,!1)}catch(E){}return OFw(I,W,t,"musicPlaylist")},Xyk=function(I){let U;
I=g.Q(I.getWatchNextResponse()?.currentVideoEndpoint,g.VJ);I?.playlistId&&(U=I.playlistId);return U},iRt=async function(I,U){const t=U.clientPlaybackNonce,W={cpn:t,
offlineSourceVisualElement:g.zY(U.on||"").getAsJson(),selectedOfflineMode:"OFFLINE_NOW",isPartialPlayback:!1};U.J&&(W.videoFmt=Number(U.J.itag));U.A&&(W.audioFmt=Number(U.A.itag));const E=Xyk(U);var Z;if(Z=E&&U.videoId)U=U.videoId,Z=await (E!=="PPSV"?Promise.resolve(!1):I.B.wk(U));Z&&(W.selectedOfflineMode="OFFLINE_MODE_TYPE_AUTO_OFFLINE");I.J=t;g.hu("offlinePlaybackStarted",W)};
g.nX.prototype.K9=g.jA(42,function(I){return this.app.K9(I)});
g.i7.prototype.K9=g.jA(41,function(I){return g.m$I(this,9,I)});
var IC=class{constructor(I){this.B=I}},Ui=class extends IC{get entityMetadata(){return this.B.entityMetadata}set entityMetadata(I){this.B.entityMetadata=I}},Yn0=class extends IC{J(){const I=[];this.B.video&&I.push(this.B.video);return[...(new Set(I))]}},kyk=class extends IC{J(){const I=[];this.B.video&&I.push(this.B.video);this.B.playlist&&I.push(this.B.playlist);this.B.videoItem&&I.push(this.B.videoItem);this.B.playlistItem&&I.push(this.B.playlistItem);return[...(new Set(I))]}},DXf=class extends IC{J(){const I=
[];this.B.localImageEntities&&I.push(...this.B.localImageEntities);this.B.videoDownloadContextEntity&&I.push(this.B.videoDownloadContextEntity);return[...(new Set(I))]}},xXw=class extends IC{J(){const I=[];this.B.recommendedVideoMetadata&&I.push(...(new DXf(this.B.recommendedVideoMetadata)).J());return[...(new Set(I))]}},rUY=class extends IC{J(){const I=[];this.B.playbackPosition&&I.push(this.B.playbackPosition);return[...(new Set(I))]}},GyQ=class extends IC{J(){const I=[];this.B.creatorEntity&&I.push(this.B.creatorEntity);
return[...(new Set(I))]}},oye=["browse","music/browse","streaming_browse","unplugged/browse"],D0x=["offline/playlist_sync_check"],Q$f=["offline"],XHH=["offline/offline_video_playback_position_sync"],YB8=["offline/get_playback_data_entity"],z4,J7=class{constructor(I){this.token=I}static async getInstance(){return new Promise(I=>{g.dD().then(U=>{U?(J7.instance||(J7.instance=new J7(U)),I(J7.instance)):I(void 0)})})}async get(I){if(I=await (await Lv(this.token)).get("prefs",I)){var U=(0,g.q)();
return I.expirationTimestampMs<=U?void 0:I.value}}async set(I,U,t=31536E3){const W=(0,g.q)();I={key:I,value:U,expirationTimestampMs:W+t*1E3};await (await Lv(this.token)).put("prefs",I)}async remove(I){await (await Lv(this.token)).delete("prefs",I)}},qn$={INVALID_ENCODER_VERSION:"Invalid encoder version",KEY_CREATION_FAILED:"Failed to create encoder key",UNKNOWN_DECODE_ERROR:"Failed to decode PES data",UNKNOWN_ENCODE_ERROR:"Failed to encode PES data",WRONG_DATA_TYPE:"Encoder cannot process the data type"},
pv=class extends g.Lm{constructor(I,U={}){super(qn$[I],{name:"PESEncoderError",type:I,...U});this.type=I;this.level="WARNING";Object.setPrototypeOf(this,pv.prototype)}},eE8=class{},bRH=class extends eE8{constructor(I){super();this.B=I}D(I,U){U=mM(U);I=(new TextEncoder).encode(JSON.stringify(I));return this.B.encrypt(I,U)}J(I,U){if(!(I instanceof Uint8Array))throw new pv("WRONG_DATA_TYPE",{u3:1});const t=new TextDecoder;U=mM(U);I=this.B.decrypt(I,U);return JSON.parse(t.decode(I))}},zxw={accountLinkStatusEntity:class extends Ui{J(){return[]}},
booleanEntity:class extends Ui{J(){return[]}},buttonEntity:class extends Ui{J(){return[]}},captionTrack:class extends Ui{J(){return[]}},channelHandle:class extends Ui{J(){return[]}},chipEntity:class extends Ui{J(){return[]}},commerceAcquisitionClientPayloadEntity:class extends Ui{J(){return[]}},commerceCartListEntity:class extends Ui{J(){return[]}},compositeSourceEntity:class extends Ui{J(){return[]}},multiviewStagingEntity:class extends Ui{J(){const I=[];this.B.compositeSourceKeys&&I.push(...this.B.compositeSourceKeys);
return[...(new Set(I))]}},contextNoteFeedEntityPayload:class extends Ui{J(){return[]}},contextNoteUserRatingEntityPayload:class extends Ui{J(){return[]}},continuationTokenEntity:class extends Ui{J(){return[]}},downloadQualityPickerEntity:class extends Ui{J(){return[]}},downloadsPageRefreshTokenEntity:class extends Ui{J(){return[]}},downloadsPageViewConfigurationEntity:class extends Ui{J(){return[]}},downloadStatusEntity:class extends Ui{J(){return[]}},dismissState:class extends Ui{J(){return[]}},
sfvAudioItemCurrentlyPlayingEntity:class extends Ui{J(){return[]}},emojiFountainDataEntity:class extends Ui{J(){return[]}},emojiCustomizationSetEntity:class extends Ui{J(){return[]}},fakeChannel:class extends Ui{J(){const I=[];this.B.alternateChannel&&I.push(this.B.alternateChannel);this.B.alternateChannelList&&I.push(...this.B.alternateChannelList);this.B.oneofChannelEntity&&I.push(this.B.oneofChannelEntity);return[...(new Set(I))]}},fakePlaylist:class extends Ui{J(){const I=[];this.B.entryCollection&&
I.push(this.B.entryCollection);return[...(new Set(I))]}},fakePlaylistEntryCollection:class extends Ui{J(){const I=[];this.B.parentPlaylist&&I.push(this.B.parentPlaylist);if(this.B.entries)for(const U of this.B.entries)I.push(...(new Yn0(U)).J());return[...(new Set(I))]}},fakeVideo:class extends Ui{J(){const I=[];this.B.descriptionEntity&&I.push(this.B.descriptionEntity);this.B.creators&&I.push(...this.B.creators);this.B.theBiggestFan&&I.push(this.B.theBiggestFan);return[...(new Set(I))]}},fakeVideoDescription:class extends Ui{J(){return[]}},
featuredProductsEntity:class extends Ui{J(){return[]}},flowStateEntity:class extends Ui{J(){return[]}},iconBadgeEntity:class extends Ui{J(){return[]}},interstitialInteractionStateEntity:class extends Ui{J(){return[]}},likeButtonAnimationEntity:class extends Ui{J(){return[]}},liveChatPollStateEntity:class extends Ui{J(){return[]}},dataFreshnessEntity:class extends Ui{J(){return[]}},liveViewerLeaderboardChatEntryPointStateEntity:class extends Ui{J(){return[]}},liveViewerLeaderboardPointsEntity:class extends Ui{J(){return[]}},
liveReactionsDataEntity:class extends Ui{J(){return[]}},logoEntity:class extends Ui{J(){return[]}},macroMarkerEntity:class extends Ui{J(){return[]}},mainDownloadsLibraryEntity:class extends Ui{J(){const I=[];this.B.downloadsList&&I.push(this.B.downloadsList);this.B.smartDownloadsList&&I.push(this.B.smartDownloadsList);this.B.recommendedDownloadsList&&I.push(this.B.recommendedDownloadsList);this.B.refresh&&I.push(this.B.refresh);return[...(new Set(I))]}},mainDownloadsListEntity:class extends Ui{J(){const I=
[];this.B.refresh&&I.push(this.B.refresh);if(this.B.downloads)for(const U of this.B.downloads)I.push(...(new kyk(U)).J());return[...(new Set(I))]}},mainPlaylistDownloadStateEntity:class extends Ui{J(){const I=[];this.B.localImageEntities&&I.push(...this.B.localImageEntities);return[...(new Set(I))]}},mainPlaylistEntity:class extends Ui{J(){const I=[];this.B.channelOwner&&I.push(this.B.channelOwner);this.B.videos&&I.push(...this.B.videos);this.B.collaboratorChannels&&I.push(...this.B.collaboratorChannels);
this.B.downloadState&&I.push(this.B.downloadState);this.B.refresh&&I.push(this.B.refresh);return[...(new Set(I))]}},mainPlaylistVideoEntity:class extends Ui{J(){const I=[];this.B.video&&I.push(this.B.video);this.B.channelContributor&&I.push(this.B.channelContributor);return[...(new Set(I))]}},mainVideoDownloadStateEntity:class extends Ui{J(){const I=[];this.B.playbackData&&I.push(this.B.playbackData);this.B.localImageEntities&&I.push(...this.B.localImageEntities);this.B.videoDownloadContextEntity&&
I.push(this.B.videoDownloadContextEntity);return[...(new Set(I))]}},mainVideoEntity:class extends Ui{J(){const I=[];this.B.owner&&I.push(this.B.owner);this.B.downloadState&&I.push(this.B.downloadState);this.B.userState&&I.push(...(new rUY(this.B.userState)).J());this.B.additionalMetadata&&I.push(...(new xXw(this.B.additionalMetadata)).J());return[...(new Set(I))]}},markersEngagementPanelSyncEntity:class extends Ui{J(){return[]}},markersVisibilityOverrideEntity:class extends Ui{J(){return[]}},musicAlbumReleaseDetail:class extends Ui{J(){const I=
[];this.B.albumRelease&&I.push(this.B.albumRelease);this.B.tracks&&I.push(...this.B.tracks);return[...(new Set(I))]}},musicAlbumReleaseDownloadMetadataEntity:class extends Ui{J(){const I=[];this.B.trackDownloadMetadatas&&I.push(...this.B.trackDownloadMetadatas);return[...(new Set(I))]}},musicAlbumRelease:class extends Ui{J(){const I=[];this.B.musicLibraryStatusEntity&&I.push(this.B.musicLibraryStatusEntity);this.B.primaryArtists&&I.push(...this.B.primaryArtists);this.B.details&&I.push(this.B.details);
this.B.userDetails&&I.push(this.B.userDetails);this.B.tracks&&I.push(...this.B.tracks);this.B.share&&I.push(this.B.share);this.B.downloadMetadata&&I.push(this.B.downloadMetadata);this.B.refresh&&I.push(this.B.refresh);return[...(new Set(I))]}},musicAlbumReleaseUserDetail:class extends Ui{J(){const I=[];this.B.albumRelease&&I.push(this.B.albumRelease);return[...(new Set(I))]}},musicArtistDetail:class extends Ui{J(){const I=[];this.B.parentArtist&&I.push(this.B.parentArtist);return[...(new Set(I))]}},
musicArtist:class extends Ui{J(){const I=[];this.B.details&&I.push(this.B.details);this.B.userDetails&&I.push(this.B.userDetails);return[...(new Set(I))]}},musicArtistUserDetail:class extends Ui{J(){const I=[];this.B.parentArtist&&I.push(this.B.parentArtist);return[...(new Set(I))]}},musicDownloadsLibraryEntity:class extends Ui{J(){const I=[];this.B.downloadedTracks&&I.push(...this.B.downloadedTracks);this.B.smartDownloadedTracks&&I.push(...this.B.smartDownloadedTracks);this.B.downloadedEpisodes&&
I.push(...this.B.downloadedEpisodes);this.B.downloadedAlbumReleases&&I.push(...this.B.downloadedAlbumReleases);this.B.smartDownloadedAlbumReleases&&I.push(...this.B.smartDownloadedAlbumReleases);this.B.downloadedPlaylists&&I.push(...this.B.downloadedPlaylists);this.B.smartDownloadedPlaylists&&I.push(...this.B.smartDownloadedPlaylists);this.B.metadataOnlyTracks&&I.push(...this.B.metadataOnlyTracks);return[...(new Set(I))]}},musicLibraryEdit:class extends Ui{J(){return[]}},musicLibraryStatusEntity:class extends Ui{J(){return[]}},
musicPlaylist:class extends Ui{J(){const I=[];this.B.tracks&&I.push(...this.B.tracks);this.B.refresh&&I.push(this.B.refresh);this.B.musicLibraryStatusEntity&&I.push(this.B.musicLibraryStatusEntity);this.B.details&&I.push(this.B.details);this.B.downloadMetadata&&I.push(this.B.downloadMetadata);this.B.sideloadMetadata&&I.push(this.B.sideloadMetadata);this.B.userDetails&&I.push(this.B.userDetails);this.B.entryCollection&&I.push(this.B.entryCollection);this.B.share&&I.push(this.B.share);this.B.podcastShowAdditionalMetadata&&
I.push(...(new GyQ(this.B.podcastShowAdditionalMetadata)).J());return[...(new Set(I))]}},musicPlaylistDownloadMetadataEntity:class extends Ui{J(){const I=[];this.B.trackDownloadMetadatas&&I.push(...this.B.trackDownloadMetadatas);return[...(new Set(I))]}},musicShare:class extends Ui{J(){return[]}},musicTrackDetail:class extends Ui{J(){const I=[];this.B.parentTrack&&I.push(this.B.parentTrack);return[...(new Set(I))]}},musicTrackDownloadMetadataEntity:class extends Ui{J(){const I=[];this.B.playbackData&&
I.push(this.B.playbackData);this.B.localImageEntities&&I.push(...this.B.localImageEntities);this.B.videoDownloadContextEntity&&I.push(this.B.videoDownloadContextEntity);return[...(new Set(I))]}},musicTrack:class extends Ui{J(){const I=[];this.B.musicLibraryStatusEntity&&I.push(this.B.musicLibraryStatusEntity);this.B.artists&&I.push(...this.B.artists);this.B.audioModeVersion&&I.push(this.B.audioModeVersion);this.B.videoModeVersion&&I.push(this.B.videoModeVersion);this.B.userDetails&&I.push(this.B.userDetails);
this.B.details&&I.push(this.B.details);this.B.albumRelease&&I.push(this.B.albumRelease);this.B.share&&I.push(this.B.share);this.B.libraryEdit&&I.push(this.B.libraryEdit);this.B.downloadMetadata&&I.push(this.B.downloadMetadata);this.B.playbackPosition&&I.push(this.B.playbackPosition);this.B.lyrics&&I.push(this.B.lyrics);return[...(new Set(I))]}},musicTrackUserDetail:class extends Ui{J(){const I=[];this.B.parentTrack&&I.push(this.B.parentTrack);return[...(new Set(I))]}},offlineOrchestrationActionWrapperEntity:class extends Ui{J(){return[]}},
offlineVideoPolicy:class extends Ui{J(){return[]}},offlineVideoStreams:class extends Ui{J(){return[]}},offlineabilityEntity:class extends Ui{J(){return[]}},orchestrationWebSamplingEntity:class extends Ui{J(){const I=[];this.B.fakeChildren&&I.push(...this.B.fakeChildren);return[...(new Set(I))]}},pageHeaderEntity:class extends Ui{J(){return[]}},pdpStateEntity:class extends Ui{J(){return[]}},pinnedProductEntity:class extends Ui{J(){return[]}},playbackData:class extends Ui{J(){const I=[];this.B.transfer&&
I.push(this.B.transfer);this.B.adsPlaybackData&&I.push(...this.B.adsPlaybackData);this.B.drmLicense&&I.push(this.B.drmLicense);this.B.offlineVideoPolicy&&I.push(this.B.offlineVideoPolicy);this.B.videoDownloadContextEntity&&I.push(this.B.videoDownloadContextEntity);return[...(new Set(I))]}},playerStateEntity:class extends Ui{J(){return[]}},quantityIncrementerEntity:class extends Ui{J(){return[]}},refresh:class extends Ui{J(){return[]}},saveToPlaylistListEntity:class extends Ui{J(){return[]}},selectedChipIndexEntityPayload:class extends Ui{J(){return[]}},
settingEntity:class extends Ui{J(){return[]}},stringEntity:class extends Ui{J(){return[]}},suggestedFeedbackChipStateEntity:class extends Ui{J(){return[]}},transfer:class extends Ui{J(){const I=[];this.B.offlineVideoStreams&&I.push(...this.B.offlineVideoStreams);this.B.captionTrack&&I.push(...this.B.captionTrack);return[...(new Set(I))]}},trendingOfferEntity:class extends Ui{J(){return[]}},videoDownloadContextEntity:class extends Ui{J(){return[]}},videoOverviewAsyncDataEntity:class extends Ui{J(){return[]}},
videoPlaybackPositionEntity:class extends Ui{J(){return[]}},votingEntity:class extends Ui{J(){return[]}},ytMainChannelEntity:class extends Ui{J(){const I=[];this.B.userChannelDetails&&I.push(this.B.userChannelDetails);return[...(new Set(I))]}},youchatPendingResponseEntity:class extends Ui{J(){return[]}},ytMainDownloadedVideoEntity:class extends Ui{J(){const I=[];this.B.video&&I.push(this.B.video);this.B.playbackData&&I.push(this.B.playbackData);this.B.offlineVideoPolicy&&I.push(this.B.offlineVideoPolicy);
return[...(new Set(I))]}},ytMainVideoEntity:class extends Ui{J(){const I=[];this.B.channelOwner&&I.push(this.B.channelOwner);this.B.playbackPosition&&I.push(this.B.playbackPosition);this.B.localImageEntities&&I.push(...this.B.localImageEntities);this.B.downloadStatus&&I.push(this.B.downloadStatus);return[...(new Set(I))]}}},Qne=class{constructor(I,U){this.B=I;this.J=U;this.D={}}},BSV=class extends eE8{D(I){return I}J(I){if(I instanceof Uint8Array)throw new pv("WRONG_DATA_TYPE",{u3:0});return I}},
Ask=class{constructor(){this.B={};this.B[0]=new BSV;if(!g.ob("aes_pes_encoder_killswitch")){var I=this.B;try{const W=g.hM();var U=mM(W);var t=new bRH(new g.xT(U),new g.XY(U))}catch(W){throw I=W instanceof Error?new pv("KEY_CREATION_FAILED",{originalMessage:W.message}):new pv("KEY_CREATION_FAILED"),g.b(I),I;}I[1]=t}}},snw=class extends g.ZW{constructor(I,U){super();this.token=I;this.B=U;this.observers=[];I=new g.k5.BroadcastChannel(`${"PERSISTENT_ENTITY_STORE_SYNC"}:${g.hM()}`);I.onmessage=this.J.bind(this);
this.channel=I}observe(I){this.observers.push(I);return()=>{const U=this.observers.indexOf(I);U>=0&&this.observers.splice(U,1)}}J(I){FD6(this,I.data)}b0(){this.channel.close()}},Yx,hGH=new g.P("elementsCommand");var Ss=new g.P("entityBatchUpdate");var l6w=new g.P("downloadStatusEntity");var Pjk=new g.P("mainPlaylistEntityActionMetadata");var nc=new g.P("mainVideoEntityActionMetadata");var FGY=new g.P("musicPlaylistEntityActionMetadata");var P2=new g.P("musicTrackEntityActionMetadata");var cU6=new g.P("localImageEntityActionMetadata");var sk=new g.P("playbackDataActionMetadata");var El$=new g.P("transferEntityActionMetadata");var RGk=new g.P("videoPlaybackPositionEntityActionMetadata");var exY=class{constructor(){this.B=new Map}},xx;new g.lq;new g.lq;var Okk=class{constructor(){this.locks=navigator.locks}request(I,U={},t){return this.locks.request(I,U,W=>t(W))}};var qc=g.k5.caches,G4,e9,TSH=class{open(I){return qc.open(rk(I))}has(I){return qc.has(rk(I))}delete(I){return qc.delete(rk(I))}async match(I,U){var t=await this.keys();for(const W of t)if(t=await (await this.open(W)).match(I,U))return t}},MEH=class extends TSH{async keys(){const I=[],U=g.hM("CacheStorage keys");var t=await qc.keys();for(const W of t){t=W.indexOf(":");const {sf:E,datasyncId:Z}=t===-1?{sf:W}:{sf:W.substring(0,t),datasyncId:W.substring(t+1)};Z===U&&I.push(E)}return I}};var RE$=class extends g.ZW{constructor(I){super();this.api=I;this.aF={jWu:()=>this.B,
e9l:()=>this.J};
typeof g.k5.BroadcastChannel!=="undefined"&&(this.B=new g.k5.BroadcastChannel(`${"PLAYER_OFFLINE_ERROR_SYNC"}:${g.hM()}`),this.B.onmessage=this.D.bind(this),this.J=new g.k5.BroadcastChannel(`${"PLAYER_OFFLINE_PAUSE_SYNC"}:${g.hM()}`),this.J.onmessage=this.A.bind(this))}D(I){g.Of(this.api,"onOfflineOperationFailure",I.data)}A(I){this.api.publish("offlinetransferpause",I.data)}b0(){this.B?.close();this.J?.close()}};var ORk=class{constructor(I,U,t){this.U=I;this.C=U;this.visibility=t;this.T=this.V=this.G=this.D=this.B=!1;this.A=new g.bP(()=>{this.q4()});
this.aF={Is:()=>this.J,
q4:()=>{this.q4()},
AUA:()=>this.A};
this.visibility.subscribe("visibilitystatechange",()=>{this.yx()})}yx(){this.B&&R6(this)}q4(){this.J&&this.J.resolve();
this.D=this.B=!1;this.C()}};var m5L=["OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"];var l3=class{constructor(I,U,t,W,E=U,Z,H,w,l,d,K){this.entityType=I;this.actionId=U;this.action=t;this.parentActionId=W;this.rootActionId=E;this.childActionIds=Z;this.prereqActionId=H;this.postreqActionIds=w;this.hasChildActionFailed=d;this.retryScheduleIndex=0;this.B=K||Date.now();this.retryScheduleIndex=l||0}};var $06="captionTrack downloadStatusEntity ytMainChannelEntity mainPlaylistEntity mainPlaylistDownloadStateEntity mainPlaylistVideoEntity mainVideoEntity mainVideoDownloadStateEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity videoPlaybackPositionEntity".split(" ");var gyV="downloadStatusEntity musicAlbumRelease musicDownloadsLibraryEntity musicPlaylist musicTrack musicTrackDownloadMetadataEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity".split(" ");var t0=class{constructor(I){this.B=I}},Nq=class{constructor(I,U,t,W,E,Z){this.status=I;this.B=U;this.A=t;this.J=W;this.D=E;this.downloadState=Z}};var nd0=class extends t0{constructor(I,U,t){super(I);this.B=I;this.O=U;this.D=t}J(I){return Mc(I)?qB$(this,I):PB(I)?Bgx(this,I):Promise.reject(Error(`Unsupported action type: ${I.actionType}`))}};var Vow=class extends t0{constructor(I,U){super(I);this.B=I;this.O=U}J(I){return PB(I)?Tg$(this,I):wHw(I)?OIL(this,I):Ir(I)?nyH(this,I):Promise.reject(Error(`Unsupported action type: ${I.actionType}`))}};var Mo0=class{constructor(I,U){this.api=I;this.B=U;this.logger=new g.m7("woffle");this.J=!1;this.aF={oa:this.oa}}async A(I){if(I.state.B(128)){const U=I.state.y$;I=U?.errorCode;I=I==="net.connect"&&U?.Z4===1?"TRANSFER_FAILURE_REASON_NETWORK_LOST":I?.startsWith("net.")?"TRANSFER_FAILURE_REASON_NETWORK":"TRANSFER_FAILURE_REASON_INTERNAL";await this.Ke(this.player.getVideoData().videoId,I)}}async Ke(I,U){this.J||(this.J=!0,U==="TRANSFER_FAILURE_REASON_NETWORK_LOST"?i3(this,I,!1,!0):(await X1(this,I),
g.kW(I,4),await this.B.Ke(U)))}Gl(I){I.status===2?(I.status!==this.D&&(b3(this.B),g.kW(I.videoId,2)),I.Qa&&aok(this.B,I.videoId,I.Qa)):I.status===4?(X1(this,I.videoId),this.Ke(I.videoId,I.jq?"TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":"TRANSFER_FAILURE_REASON_INTERNAL")):I.status===1&&JVH(this.B);this.D=I.status;g.Of(this.api,"localmediachange",{videoId:I.videoId,status:I.status})}async e8(){if(!this.J){this.J=!0;var I=this.player.getVideoData().videoId;await X1(this,I);await this.B.e8()}}oa(I){switch(I){case "HD_1080":return"hd1080";
case "HD":return"hd720";case "SD":return"large";case "LD":return"tiny";default:return"hd720"}}K(I){return this.api.S().K(I)}};var P2Q=class extends t0{constructor(I,U){super(I);this.B=I;this.O=U}J(I){return Mc(I)?U5t(this,I):PB(I)?tTH(this,I):wHw(I)?Wtx(this,I):Promise.reject(Error(`Unsupported action type: ${I.actionType}`))}};var IAe=class{constructor(){this.actions=[]}B(I,U){let t=I.action.actionMetadata.priority-U.action.actionMetadata.priority;t===0&&(I.B<U.B?t=-1:I.B>U.B&&(t=1));return t}};var KtY=class extends g.ZW{constructor(I,U,t,W,E){super();this.J=I;this.on=U;this.mu=t;this.V=W;this.O=E;this.B=new IAe;this.G=new g.u_;this.D=new g.bP(()=>{this.retry()});
this.U=NaN;this.T=!1;this.aF={u8g:()=>this.B,
zF:()=>this.G,
R9l:()=>this.D,
retry:()=>this.retry()};
g.J(this,this.D);this.C=this.J.observe(this.N.bind(this))}b0(){this.C&&this.C();super.b0()}createAction(I,U){const t=g.Oo(I.entityKey).entityType,W=g.hj(16);return new l3(t,W,I,U.actionId,U.rootActionId)}async N(I){if(!this.Xe()){var U=I.offlineOrchestrationActionWrapperEntity??new Set;I=[];for(var t of U)({entityId:U}=g.Oo(t)),d5H(this.B,U)||I.push(t);t=await LtH(this,I);await D$(this,t)}}async retry(){await Cjf(this)}};var UEH=class{constructor(I){this.xA=I;this.B=void 0}async Og(I,U=!0){if(this.B){var t=[],W=g.U8(this.B.B,U),E=[];for(let Z=0;Z<W.length;Z++)U=this.B.G(W[Z],"json3"),U=g.Rb(U,{withCredentials:!0,format:"RAW"},3,500).then(H=>{H={metadata:g.Ld(W[Z]),trackData:H.xhr.responseText};E.push(H)}).V3(H=>{BB("Caption fetch error",H)}),t.push(U);
await dgH(t);try{await k2H(I,E)}catch(Z){BB("Caption DB transaction error",Z)}}}};var tPk=class extends g.ZW{constructor(I){super();this.B=I;this.J=this.B.observe(this.D.bind(this))}b0(){this.J&&this.J();super.b0()}async D(I){var U=I.transfer??new Set;I=[];for(const t of U)({entityId:U}=g.Oo(t)),I.push(U);I.length!==0&&await Q5x(this,I)}};var bFL=class extends g.ZW{constructor(I,U,t,W){super();this.J=I;this.api=U;this.QQ=t;this.N=W;this.G=new g.u_;this.A=new g.bP(()=>{this.B&&this.B.transferState==="TRANSFER_STATE_TRANSFERRING"&&this.G.oU()&&((this.B.transferRetryCount||0)<3?i3(this.V,this.T,!1,!1):X1(this.V,this.T.videoDetails.videoId),this.Ke("TRANSFER_FAILURE_REASON_TIMEOUT_NO_PROGRESS"))});
this.mu=this.l0=0;this.C=this.U=!1;this.hs=g.ri(this.api.S().experiments,"html5_transfer_processing_logs_interval");this.yQ=new g.E9(this);this.aF={KY0:()=>this.A,
wZn:()=>this.N,
zF:()=>this.G};
this.on=this.J.observe(this.Rn.bind(this));this.V=new Mo0(U,this);this.qd=new UEH(U);this.wk=new tPk(this.J);this.u0=this.G.listen("publicytnetworkstatus-online",this.RR.bind(this));this.Js=this.G.listen("publicytnetworkstatus-offline",this.Md.bind(this));this.C=this.api.S().K("html5_less_transfer_processing_logs");g.J(this,this.yQ);this.yQ.L(U,"offlinetransferpause",this.UJ);if(g.Ut(this.api.S()))this.D="mainVideoDownloadStateEntity";else if(g.TD(this.api.S())||g.WI(this.api.S()))this.D="musicTrackDownloadMetadataEntity"}b0(){this.on&&
this.on();this.wk.dispose();this.A.dispose();this.u0&&g.cN(this.G.WN,this.u0);this.Js&&g.cN(this.G.WN,this.Js);super.b0()}async UJ(I){const U=g.nN(I,"transfer");if(this.B&&U===this.B.key)i3(this.V,this.T,!0),this.A.stop();else{const t=await Nc(this.J,{mode:"readwrite",x$:!0},W=>yO(W,U,"transfer").then(E=>{if(E&&E.transferState!=="TRANSFER_STATE_COMPLETE"&&E.transferState!=="TRANSFER_STATE_FAILED")return E.transferState="TRANSFER_STATE_PAUSED_BY_USER",j9(W,E,"transfer").then(()=>E)}));
if(t){I&&this.D&&await Uk(I,this.D,this.J,"DOWNLOAD_STATE_PAUSED");const W=await rF(this,I);ZIt({videoId:I,GV:t,offlineModeType:W})}}}Md(){if(this.B&&this.T){i3(this.V,this.T,!1);const I=this.B,U=I?.key?g.Oo(I.key).entityId:"";U&&this.D&&(new Promise((t,W)=>{Uk(U,this.D,this.J,"DOWNLOAD_STATE_PAUSED").catch(E=>{W(E)})})).catch(t=>{BB("Download state setting error",t)})}this.A.stop()}RR(){this.B?x5x(this,this.B):es(this)}async Rn(I){if(this.B&&(this.B.transferState!=="TRANSFER_STATE_COMPLETE"&&this.B.transferState!==
"TRANSFER_STATE_FAILED"&&I.transfer&&I.transfer.has(this.B.key)&&((this.B=await Xc(this.J,this.B.key,"transfer"))||await rVH(this)),this.B))return;
await es(this)}async Ke(I,U){if(this.B){var t=this.B;const E=t?.key?g.Oo(t.key).entityId:"";a:switch(I){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_PLAYABILITY":case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":var W=!1;break a;default:W=!0}W&&Gb$(this)?(await xK(this,"TRANSFER_STATE_TRANSFER_IN_QUEUE"),I=await rF(this,E),nv({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_RETRY"},{videoId:E,GV:t,offlineModeType:I}),
E&&this.D&&await Uk(E,this.D,this.J,"DOWNLOAD_STATE_RETRYABLE_FAILURE")):(await q4x(this,I),E&&this.D&&await Uk(E,this.D,this.J,"DOWNLOAD_STATE_FAILED"))}else Gw(this,`onTransferFailure: ${I}`);qq(this);t=es(this,!0);U&&U(t)}async e8(I){if(this.B)if(Gb$(this)){await xK(this,"TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH");this.B||Gw(this,"onMaybeTransferStreamsExpiredRetryAttempting");var U=this.B,t=U?.key?g.Oo(U.key).entityId:"",W=await rF(this,t);nv({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_PLAYER_RESPONSE_EXPIRATION"},
{videoId:t,GV:U,offlineModeType:W});U=wF();g.DP(U,sk,{isEnqueuedForExpiredStreamUrlRefetch:!0});W=g.nN(t,"playbackData");t=Kc(new l3("playbackData",t,{actionType:"OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",entityKey:W,actionMetadata:U}));await JF(this.J,t,"offlineOrchestrationActionWrapperEntity")}else await q4x(this,"TRANSFER_FAILURE_REASON_STREAM_MISSING"),this.D&&(t=this.B,(t=t?.key?g.Oo(t.key).entityId:"")&&await Uk(t,this.D,this.J,"DOWNLOAD_STATE_FAILED"));else Gw(this,"onMaybeTransferStreamsExpired");
qq(this);t=es(this,!0);I&&I(t)}},B2={TRANSFER_STATE_TRANSFERRING:1,TRANSFER_STATE_TRANSFER_IN_QUEUE:2};var W6Q=class{constructor(I,U){this.O=I;this.api=U;this.V=new g.u_;this.T=new g.lq;this.aF={Is:()=>this.D.aF.Is(),
zF:()=>this.V,
FYn:()=>this.D,
B1:()=>this.B1(),
jV:()=>this.jV(),
PV:()=>this.PV(),
ul:()=>this.ul(),
kH:()=>this.kH(),
Xk:t=>this.Xk(t)};
this.D=new ORk(()=>eiQ(this),()=>{this.PV()},this.api.CX(),this.api.K.bind(this.api));
this.B=new RE$(this.api);I6t(this.D)}B1(){return this.T.promise}jV(){if(this.J&&this.U)return this.T.promise;TaY(this).then(this.T.resolve).catch(this.T.reject);return this.T.promise}G(I){return{playbackData:new nd0(I,this.O,this.B),transfer:new P2Q(I,this.O),videoPlaybackPositionEntity:new Vow(I,this.O)}}async ul(){this.J&&await olH(this.J)}async PV(){if(this.J||this.U)await this.B1(),this.mu!==void 0&&(g.Ni(this.mu),this.mu=void 0),this.A!==void 0&&(g.Ni(this.A),this.A=void 0),this.J?.dispose(),
this.J=void 0,this.U?.dispose(),this.U=void 0,g.Of(this.api,"onOrchestrationLostLeader"),this.T=new g.lq}isOrchestrationLeader(){return this.D.B}async wk(){return!1}c$(I){var U=this.B;U.api.publish("offlinetransferpause",I);U.J?.postMessage(I)}async RR(I){const U=await kx();if(U){var t=g.nN(I,"transfer");await Nc(U,{mode:"readwrite",x$:!0},W=>{const E=yO(W,t,"transfer"),Z=yO(W,g.nN(I,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.xG.all([E,Z]).then(([H,w])=>H&&H.transferState===
"TRANSFER_STATE_PAUSED_BY_USER"?(H.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE",j9(W,H,"transfer").then(()=>{nv({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_USER_RESUME",statusType:"USER_RESUMED"},{videoId:I,GV:H,offlineModeType:w?.offlineModeType});return g.xG.resolve(null)})):g.xG.resolve(null))})}}async on(I=43200){if(!this.V.oU())return Rik();
var U=await kx();if(!U)return[];const t=Date.now()/1E3;var W=await iB(U,"offlineVideoPolicy");U=[];for(const E of W)Number(E.lastUpdatedTimestampSeconds)+I<=t&&(W=g.Oo(E.key).entityId,U.push(W));return U.length?Tw(this,U,this.N,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"):[]}deleteAll(){return Tw(this,["!*$_ALL_ENTITIES_!*$"],this.N,"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}})}async refreshAllStaleEntities(I){return await this.on(I)}setUpPositionSyncInterval(I){this.A!==
void 0&&(g.Ni(this.A),this.A=void 0);const U=I??864E5;this.A=g.sJ(()=>{this.Xk(U)},U)}async Xk(I){try{const U=await J7.getInstance();
if(!U)throw Error("prefStorage is undefined");const t=await U.get("psi"),W=t?.hE?Number(t.hE)/1E3:0,E=Date.now();W+I<=E&&await Tw(this,["!*$_ALL_ENTITIES_!*$"],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH")}catch(U){BB("Offline manager error",U)}}async kH(){var I=await kx();if(!I)return[];var U=await iB(I,"transfer");I=[];for(const t of U)t.transferState==="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH"&&t.key&&(U=g.Oo(t.key).entityId,I.push(U));return nlV(this,I)}async C(){return[]}async Js(){}async l0(){}};var EDL=class extends t0{constructor(I,U,t){super(I);this.B=I;this.O=U;this.D=t}J(I){return Mc(I)?MTY(this,I):PB(I)?I7f(this,I):Ir(I)?UXt(this,I):Promise.reject(Error(`Unsupported action type: ${I.actionType}`))}},Rr=[10];var Zw6=class extends t0{constructor(I,U,t){super(I);this.B=I;this.O=U;this.D=t}J(I){return Mc(I)?l7x(this,I):PB(I)?dX0(this,I):Ir(I)?K4$(this,I):Promise.reject(Error(`Unsupported action type: ${I.actionType}`))}},wye=[10];var Hw6=class extends t0{constructor(I,U,t){super(I);this.B=I;this.O=U;this.D=t}J(I){return PB(I)?$XV(this,I):Promise.reject(Error(`Unsupported action type: ${I.actionType}`))}};var wl0=class extends W6Q{constructor(){super(...arguments);this.N="mainVideoEntity"}G(I){const U=super.G(I);U.mainVideoEntity=new Zw6(I,this.O,this.B);U.mainPlaylistEntity=new EDL(I,this.O,this.B);U.mainDownloadsListEntity=new Hw6(I,this.O,this.B);return U}async refreshAllStaleEntities(I,U){let t=[];this.O.K("web_player_offline_playlist_auto_refresh")&&(t=await uIe(this,I,U));var W=await J7.getInstance();const E=await W?.get("sdois");W=await W?.get("lmqf");E&&(t=t.concat(await hEw(this,E,W??"SD",
I===0)));return t=t.concat(await super.refreshAllStaleEntities(I,U))}async wk(I){var U=await kx();if(!U)return!1;U=await Xc(U,g.ex,"mainDownloadsListEntity");if(U?.downloads?.length){I=g.nN(I,"mainVideoEntity");for(const t of U.downloads)if(t.videoItem===I)return!0}return!1}async C(){var I=await kx();if(!I)return[];var U=await iB(I,"downloadStatusEntity");I=[];for(const t of U)t.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&t.key&&(U=g.Oo(t.key).entityId,I.push(U));return I.length?Tw(this,I,"mainVideoEntity",
"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}}):[]}async l0(){const I=await kx();I&&await Nc(I,{mode:"readwrite",x$:!0},U=>Fc(U,"mainVideoEntity").then(t=>{const W=[];for(const E of t)E.userState?.playbackPosition||(t=g.Oo(E.key).entityId,t={key:g.nN(t,"videoPlaybackPositionEntity"),videoId:t,lastPlaybackPositionSeconds:"0"},W.push(j9(U,t,"videoPlaybackPositionEntity")),E.userState={playbackPosition:t.key},W.push(j9(U,E,
"mainVideoEntity")));return g.xG.all(W)}))}async Js(){const I=await kx();
if(I){var U=g.nN("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),t=await Nc(I,{mode:"readonly",x$:!0},v=>g.xG.all([yO(v,U,"mainDownloadsListEntity"),yO(v,g.ex,"mainDownloadsListEntity"),Fc(v,"mainVideoEntity"),Fc(v,"mainPlaylistEntity")])),[W,
E,Z,H]=t;t=new Set;if(W?.downloads?.length)for(var w of W.downloads){var l=w.videoItem??w.playlistItem;l&&t.add(l)}if(E?.downloads?.length)for(var d of E.downloads)d.videoItem&&t.add(d.videoItem);w=new Set;d=[];for(var K of H){if(K.videos)for(const v of K.videos)(l=JSON.parse(g.Oo(v).entityId).videoId)&&w.add(l);K.key&&!t.has(K.key)&&d.push(K.key)}for(const v of Z)v.key&&!t.has(v.key)&&(K=g.Oo(v.key).entityId,w.has(K)||d.push(v.key));d.length&&await zw(I,d)}}};var lAQ=class extends t0{constructor(I,U){super(I);this.B=I;this.D=U}J(I){return Mc(I)?zE6(this,I):PB(I)?L4t(this,I):Ir(I)?pyQ(this,I):Promise.reject(Error(`Unsupported action type: ${I.actionType}`))}},Vg=[10];var dEf=class extends t0{constructor(I,U){super(I);this.B=I;this.D=U}J(I){return Mc(I)?C2V(this,I):PB(I)?yU6(this,I):Ir(I)?F46(this,I):Promise.reject(Error(`Unsupported action type: ${I.actionType}`))}},Mq=[10];var K6e=class extends t0{constructor(I,U){super(I);this.B=I;this.D=U}J(I){return Mc(I)?sUw(this,I):PB(I)?a7Q(this,I):Ir(I)?NS0(this,I):Promise.reject(Error(`Unsupported action type: ${I.actionType}`))}},AUf=[10];var vDV=class extends W6Q{constructor(){super(...arguments);this.N="musicTrack"}G(I){const U=super.G(I);U.musicTrack=new K6e(I,this.B);U.musicPlaylist=new dEf(I,this.B);U.musicAlbumRelease=new lAQ(I,this.B);return U}async refreshAllStaleEntities(I,U){let t=await odt(this,I,U);return t=t.concat(await super.refreshAllStaleEntities(I,U))}};g.g7("offline",class extends g.p0{constructor(){super(...arguments);this.events=new g.E9(this);this.O=this.player.S();this.aF={bJQ:()=>this.B,
f0:()=>this.f0(),
qG:I=>this.qG(I)}}create(){g.J(this,this.events);
if(g.Ut(this.O))this.B=new wl0(this.O,this.player);else if(g.TD(this.O)||g.WI(this.O))this.B=new vDV(this.O,this.player);this.events.L(this.player,"onPlaybackStartExternal",()=>{this.f0()});
this.events.L(this.player,"videodatachange",()=>{this.f0()});
this.O.K("html5_offline_playback_position_sync")&&this.events.L(this.player,"presentingplayerstatechange",this.qG)}l6(){return!1}async Kq(I,U,t,W){return this.B?Tw(this.B,I,U,t,W):Promise.reject()}deleteAll(){return this.B.deleteAll()}on(I){return this.B.on(I)}refreshAllStaleEntities(I){return this.B.refreshAllStaleEntities(I)}setUpPositionSyncInterval(I){this.B.setUpPositionSyncInterval(I)}c$(I){this.B.c$(I)}RR(I){return this.B.RR(I)}async f0(){const I=this.player.getVideoData();I.RF()&&Xyk(I)&&
this.J!==I.clientPlaybackNonce&&await iRt(this,I)}async qG(I){var U=this.player.getVideoData();const t=U.Gk;if(I.dS(2)||I.dS(512))(I=await kx())?(U=U.videoId,await Xc(I,g.nN(U,"mainVideoEntity"),"mainVideoEntity")&&await this.Kq([U],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE",{videoPlaybackPositionEntityActionMetadata:{lastPlaybackPositionSeconds:Math.floor(t).toString()}})):BB("PES is undefined")}isOrchestrationLeader(){return this.B.isOrchestrationLeader()}async updateDownloadState(I,
U){const t=await kx();if(t){var {entityType:W,entityId:E}=g.Oo(I);await Uk(E,W,t,U,!0)}else BB("PES is undefined")}});})(_yt_player);
